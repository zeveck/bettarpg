(()=>{"use strict";class e{static PLAYER={STARTING_STATS:{level:1,hp:20,maxHp:20,mp:10,maxMp:10,exp:0,bettaBites:0},PROGRESSION:{EXP_BASE:100,EXP_MULTIPLIER:1.2,HP_GAIN_PER_LEVEL:5,MP_GAIN_PER_LEVEL:2},ARMOR_SYSTEM:{LEVELS:{1:{sprite:"player_betta.png",reduction:0,name:"No Armor"},3:{sprite:"player_betta_with_helmet.png",reduction:1,name:"Helmet"},5:{sprite:"player_betta_with_almost_armor.png",reduction:2,name:"Advanced Armor"},7:{sprite:"player_betta_full_metal.png",reduction:3,name:"Full Metal Armor"}},SUBMARINE:{sprite:"dunkleosteus_sub.png",invulnerable:!0,name:"Ancient Submarine"}}};static COMBAT={SPELLS:{BUBBLE_BLAST:{name:"Bubble Blast",mpCost:3,damageMin:5,damageMax:12,unlockLevel:1,sound:"bubble"},GRAVEL_GRENADE:{name:"Gravel Grenade",mpCost:5,damageMin:8,damageMax:15,unlockLevel:4,sound:"gravel"},HAPPY_BALLOON_TIME:{name:"Happy Balloon Time",mpCost:7,damageMin:0,damageMax:0,unlockLevel:7,sound:"party"}},PLAYER_DAMAGE:{baseMin:3,baseMax:10},ENEMY_SCALING:{HP_BASE_MULTIPLIER:1,HP_LEVEL_MULTIPLIER:.5,DAMAGE_BASE_MULTIPLIER:1,DAMAGE_LEVEL_MULTIPLIER:.3,EXP_LEVEL_MULTIPLIER:.2,BETTA_BITES_REWARDS:{baseMin:1,baseMax:5,levelBonusMin:1,levelBonusMax:2}},RUN_AWAY:{difficultEnemyLevel:5,difficultEscapeChance:.1}};static ENEMIES={AGGRESSIVE_GUPPY:{name:"Aggressive Guppy",baseHp:8,baseDamage:2,baseExp:15,sprite:"aggressive_guppy.png",attacks:["darts forward with surprising speed!","attempts to nip at your fins!","swims in an erratic pattern, then strikes!"]},TERRITORIAL_ANGELFISH:{name:"Territorial Angelfish",baseHp:12,baseDamage:4,baseExp:25,sprite:"territorial-angelfish.png",attacks:["spreads its fins menacingly!","defends its territory with a fierce attack!","glides forward with elegant aggression!"]},SNEAKY_CATFISH:{name:"Sneaky Catfish",baseHp:15,baseDamage:4,baseExp:35,sprite:"sneaky_catfish.png",attacks:["strikes from the shadows!","uses its whiskers to sense your movement, then attacks!","lurks near the bottom, then lunges upward!"]},FIERCE_CICHLID:{name:"Fierce Cichlid",baseHp:18,baseDamage:6,baseExp:45,sprite:"fierce_cichlid.png",attacks:["charges with incredible force!","displays bright colors before attacking!","uses its powerful jaws in a devastating bite!"]},PREHISTORIC_GAR:{name:"Prehistoric Gar",baseHp:25,baseDamage:22,baseExp:200,sprite:"prehistoric_gar.png",isBoss:!0,special:{roarTurns:[1,4,7],roarSound:"roar",gargantuanAttack:{turn:3,name:"GARGANTUAN GAR",damage:100,channelMessage:"‚ö° The Prehistoric Gar channels ancient power! ‚ö°",attackMessage:"üêâ GARGANTUAN GAR! üêâ",defenseMessage:"The ancient submarine armor withstands even the Gargantuan Gar!",damageMessage:"The GARGANTUAN GAR deals {damage} devastating damage!",visualEffect:"giant_gar",sound:"roar",delay:1e3}},attacks:["opens its ancient jaws!","unleashes its prehistoric fury!","strikes with primordial power!"]}};static WORLD={MAP_SIZE:21,VILLAGE_CENTER:{x:10,y:10},ENCOUNTER_RATES:{COMBAT:.3,TREASURE:.3,PEACEFUL:.3,MYSTERY:.1},DANGER_ZONES:{SAFE_RADIUS:4,DANGEROUS_RADIUS:7,LEVEL_SCALING:{SAFE:{min:1,max:2},DANGEROUS:{min:3,max:5},EXTREME:{min:10,max:10}}}};static ECONOMY={SERVICES:{INN_REST:{cost:5,effect:"full_restore"}},INCOME_SOURCES:{TREASURE_BASE:{min:1,max:3}}};static GAME={VERSION:"0.4.10",WEBSITE:"https://github.com/zeveck/bettarpg"};static SHOP={SUBMARINE:{cost:100,id:"submarine"},KELP_SNACK:{cost:3,id:"kelp_snack"},BUBBLE_WATER:{cost:2,id:"bubble_water"},INN_REST:{cost:5,id:"rest"}};static UI={COLORS:{RED:{filter:"hue-rotate(0deg) saturate(1.2)"},BLUE:{filter:"hue-rotate(180deg) saturate(1.3)"},PURPLE:{filter:"hue-rotate(270deg) saturate(1.8)"},GREEN:{filter:"hue-rotate(140deg) saturate(1.2) brightness(0.85)"},ORANGE:{filter:"hue-rotate(30deg) saturate(1.8) brightness(1.1)"}}}}class t{static UI={BUTTONS:{START_GAME:"Swim to Village",START_ADVENTURE:"Start Adventure",CONTINUE:"Continue...",GOODBYE:"Goodbye",BROWSE_ITEMS:"Browse Items",MAYBE_LATER:"Maybe later",ATTACK:"Attack",SWIM_AWAY:"Swim Away",REST:"Rest ({cost} Betta Bites)",REST_WITH_COST:"Rest ({cost} Betta Bites)",CLOSE:"Close",OK:"OK",YES:"Yes",NO:"No",THANKS:"Thanks!",AMAZING:"Amazing!",NEW_NAME:"New Name",CONTINUE_SWIMMING:"Continue Swimming"},DIALOGUE_OPTIONS:{REST_SUFFIX:" - Not enough Betta Bites"},LABELS:{NAME_YOUR_BETTA:"Name your betta:",CHOOSE_COLOR:"Choose your color:",ENTER_NAME:"Enter name",ENTER_NAME_AND_CHOOSE_COLOR:"Enter name and choose color",HP:"HP",MP:"MP",LEVEL:"Level",EXP:"EXP",BETTA_BITES:"Betta Bites",NAME_PREVIEW:"Name:",COLOR_PREVIEW:"Color:",UNKNOWN_NAME:"???",CHOOSE_A_COLOR:"Choose a color"},SCREENS:{TITLE:"Betta Fish RPG",SUBTITLE:"Adventure awaits in the aquatic realm!",CREATE_YOUR_BETTA:"Create Your Betta",COMBAT_TITLE:"Combat!",VILLAGE_TITLE:"Paddy Village"},COLORS:{RED:"Red",BLUE:"Blue",PURPLE:"Purple",GREEN:"Green",ORANGE:"Orange"}};static LOCATIONS={VILLAGE:{NAME:"Paddy Village",DESCRIPTION:"Rice stalks sway gently in the water above, providing shelter for various bettas going about their daily lives.",BUILDINGS:{ELDER_DWELLING:"üèõÔ∏è Elder's Dwelling",FISH_MART:"üõí Fish Mart",VILLAGE_GUARD:"‚öîÔ∏è Village Guard",BUBBLES_HOME:"‚ú® Bubble's Home",SWISHY_SOLACE_INN:"üè® Swishy Solace Inn",EXIT_TO_PADDIES:"üó∫Ô∏è Exit to Rice Paddies (‚Üì)"}},WORLD_MAP:{NAME:"The Rice Paddies",DESCRIPTION:"You swim through the interconnected rice paddies. Tall stalks create a maze of waterways where danger and adventure lurk.",MOVEMENT:{SWIM_NORTH:"‚¨ÜÔ∏è Swim North",SWIM_SOUTH:"‚¨áÔ∏è Swim South",SWIM_EAST:"‚û°Ô∏è Swim East",SWIM_WEST:"‚¨ÖÔ∏è Swim West",RETURN_TO_VILLAGE:"üè† Return to Village"}}};static NPCS={ELDER_FINN:{NAME:"Elder Finn",DIALOGUES:["Welcome, young one. I sense great potential in you.","There have been strange happenings lately... fish have been disappearing from the outer paddies.","The rumors speak of dark shadows that come when the rice stalks sway. Perhaps you could investigate?","Be careful out there, little betta. The paddies hold many dangers."]},SHOPKEEPER_CORAL:{NAME:"Shopkeeper Coral",DIALOGUES:["Welcome to my shop! Though I'm afraid business has been slow lately.","With all these disappearances, fewer fish dare to venture between the rice stalks.","I've heard whispers of something lurking in the deeper paddies...","I do have one special item - an ancient Dunkleosteus submarine for {cost} Betta Bites! Would you like to see my wares?"]},GUARD_CAPTAIN_REEF:{NAME:"Guard Captain Reef",DIALOGUES:["Halt! State your business, young betta.","I've been keeping watch, but these mysterious abductions have me worried.","Three of our villagers vanished last week while foraging near the tall rice. No trace, no struggle... just gone.","If you're thinking of investigating, be very careful. Whatever's out there is dangerous."]},BUBBLE_THE_BRAVE:{NAME:"Bubble the Brave",DIALOGUES:["Hey there! I'm Bubble! I've been wanting to explore the outer paddies forever!","My fins are strong and I know the waterways better than anyone my age!","I dream of swimming up to the big city on the next terrace! They say it's amazing up there!","When you decide to investigate these disappearances... well, I'd love to come with you!"]},INNKEEPER_SEAWEED:{NAME:"Innkeeper Seaweed",DIALOGUES:["Welcome to the Swishy Solace Inn! You look tired, young betta.","A good rest in our soft kelp beds will restore your strength.","For just {cost} Betta Bites, you can sleep safely and wake up refreshed!","Would you like to rest? (This will fully restore your HP and MP for {cost} Betta Bites)"]}};static COMBAT={COMBAT_BEGINS:"Combat begins! {playerName} vs {enemyName}",ENEMY_APPEARS:"A wild {enemyName} (Level {level}) appears!",ENEMY_DEFEATED:"Defeated {enemyName}!",ENEMY_BEFRIENDED:"You befriended {enemyName}!",VICTORY_REWARDS:"Victory! You gained {exp} EXP and {bettaBites} Betta Bites!",LEVEL_UP:"Level up! Now level {newLevel}!",HP_MP_INCREASE:"HP increased by {hpIncrease}! MP increased by {mpIncrease}!",ARMOR_HELMET:"You've gained a protective helmet!",ARMOR_ADVANCED:"Your armor has been upgraded to advanced protection!",ARMOR_PROTECTIVE:"You're now wearing advanced protective armor!",ARMOR_FULL_METAL:"You've achieved full metal armor! Maximum protection!",GAINED_EXP:"Gained {exp} EXP!",GAINED_BETTA_BITES:"Found {amount} Betta Bites!",NOT_ENOUGH_MP:"Not enough MP to cast {spellName}!",SPELL_UNLOCKED_AT_LEVEL:"{spellName} unlocks at level {level}!",PLAYER_DEFEATED:"You have been defeated!",PLAYER_LOST_BETTA_BITES:"You lost {amount} Betta Bites...",PLAYER_RECOVERY:"You wake up back in the village, feeling groggy but alive.",ESCAPE_SUCCESS:"You managed to escape!",ESCAPE_FAILED:"You try to escape, but the enemy is too fast!",ESCAPE_BARELY_SUCCESS:"You barely manage to slip away!",DEFEAT_RECOVERY:"You wake up back in the village, rescued by other bettas. You feel fully recovered!",DEFEAT_RECOVERY_RESCUED:"You wake up back in the village, rescued by other bettas.",DEFEAT_RECOVERY_LOSS:"You lost {amount} Betta Bites but feel fully recovered!",PREHISTORIC_GAR_ROAR:"ü¶ï The Prehistoric Gar lets out a thunderous roar instead of attacking! ü¶ï",ATTACK_DESCRIPTIONS:["strikes with swift fins","lunges forward aggressively","delivers a powerful tail slap","bites with determination","charges with fierce intensity"],BUBBLE_DESCRIPTIONS:["unleashes a torrent of magical bubbles","creates a swirling vortex of powerful bubbles","summons a burst of explosive bubbles","channels energy into a devastating bubble storm"],GRAVEL_DESCRIPTIONS:["hurls a barrage of sharp gravel","creates a devastating stone storm","launches a powerful gravel grenade","summons a whirlwind of crushing rocks"],BALLOON_DESCRIPTIONS:["throws a magical party with colorful balloons","creates an irresistible celebration","starts a friendship festival","channels pure joy and happiness"],ENEMY_ATTACK_DEFLECTED:"{enemyName} {attackDescription} but the ancient armor deflects all damage!",ENEMY_ATTACK_DAMAGE:"{enemyName} {attackDescription} for {damage} damage!",MADE_FRIEND:"You made a friend!"};static EXPLORATION={MOVEMENT:{DIRECTIONS:{NORTH:"You swim north through the rice stalks, water becoming murkier.",SOUTH:"You swim south where the water runs clearer near the village.",EAST:"You swim east toward the morning sun, rice casting long shadows.",WEST:"You swim west where the rice grows thickest and oldest."},VILLAGE_EXIT:"You venture into the rice paddies, leaving the safety of Paddy Village behind.",VILLAGE_RETURN:"You return to the safety of Paddy Village."},ENCOUNTERS:{PEACEFUL:["You find a peaceful stretch of water between the rice stalks.","The water here is calm and refreshing.","You rest briefly in the gentle current.","The rice stalks sway gently overhead."],TREASURE:["You discover {amount} Betta Bites hidden among the rice roots!","A glint catches your eye - {amount} Betta Bites floating near a rice stalk!","You nose around the mud and find {amount} delicious Betta Bites!","Lucky you! {amount} Betta Bites were tucked behind some algae!"],MYSTERY:["You sense something mysterious in these waters...","Strange shadows move between the rice stalks.","An eerie feeling washes over you.","You notice disturbed mud and broken rice stems... something was here recently."]},DANGER_WARNINGS:{EDGE_ZONE:"The water here teems with dangerous predators!"},VILLAGE_MESSAGES:{RETURN_TO_SAFETY:"You return to the safety of the village.",WELCOME_TO_VILLAGE:"Welcome to the Betta village! You are safe here.",NEED_TO_BE_AT_CENTER:"You need to be at the village center to enter.",ALREADY_OUTSIDE:"You're already outside the village.",SAFELY_RETURNED:"You return safely to the village."}};static SHOP={HEADER:"üõí Fish Mart Inventory",ITEMS:{SUBMARINE:{NAME:"üöÄ Dunkleosteus Submarine",DESCRIPTION:"An ancient submarine that protects from Giant Gar attacks",PRICE:"{cost} Betta Bites"},KELP_SNACK:{NAME:"üåø Kelp Snack",DESCRIPTION:"A crunchy kelp snack that fully restores HP!",PRICE:"{cost} Betta Bites"},BUBBLE_WATER:{NAME:"üíß Bubble Water",DESCRIPTION:"Fizzy bubble water that fully restores MP",PRICE:"{cost} Betta Bites"}},ERRORS:{ITEM_NOT_FOUND:"Item not found!",NOT_ENOUGH_BETTA_BITES:"You don't have enough Betta Bites!",UNKNOWN_ITEM_EFFECT:"Unknown item effect!",INSUFFICIENT_FUNDS_FOR_REST:"You don't have enough Betta Bites! Rest costs {cost} Betta Bites."},CONFIRMATIONS:{SUBMARINE:"Excellent choice! The mysterious ancient vessel is now yours! You feel its power transforming your very essence. You are no longer just a betta - you are a legendary sea creature!",KELP_SNACK:"You munch on the crunchy kelp snack! It restores {hpHealed} HP to full! Delicious!",BUBBLE_WATER:"You sip the fizzy bubble water! It restores {mpRestored} MP to full! Refreshing!"},INLINE_SHOP:{HEADER:"üõí Fish Mart Inventory",FOOTER:"Your Betta Bites: {bettaBites}",COST_SUFFIX:" Betta Bites"}};static INN={REST_SUCCESS:"You pay {cost} Betta Bites and rest in the soft kelp beds. You wake up completely refreshed! HP and MP fully restored.",CONFIRMATION:"You rest peacefully in the soft kelp beds. You feel completely refreshed!",REST_NOT_ENOUGH:"You don't have enough Betta Bites to rest. ({cost} Betta Bites required)"};static CHARACTER_CREATION={PREVIEW:{NAME_LABEL:"Name: {name}",COLOR_LABEL:"Color: {color}",UNKNOWN_NAME:"???",CHOOSE_COLOR:"Choose a color"},WELCOME_MESSAGE:"Welcome to Paddy Village, {playerName}! Your adventure begins here.",RANDOM_NAMES:["Bubbles","Finley","Shimmer","Sparkle","Azure","Coral","Pearl","Splash","Ripple","Current","Flow","Wave","Tide","Marina","Ruby","Sapphire","Emerald","Topaz","Amber","Crystal","Diamond","Sunny","Misty","Stormy","Windy","Cloudy","Rainy","Dewy","Happy","Lucky","Brave","Swift","Gentle","Proud","Noble","Zippy","Peppy","Snappy","Flippy","Swishy","Splashy","Bubbly","Aqua","Cyan","Teal","Turquoise","Indigo","Violet","Magenta","Finn","Gil","Scale","Reef","Kelp","Algae","Plankton","Nemo","Dory","Ariel","Flounder","Sebastian","Ursula","Triton","Alpha","Beta","Gamma","Delta","Sigma","Omega","Zeta"]};static SYSTEM={CHEATS:{BETTA_BITES_ADDED:"üí∞ Cheat activated! +100 Betta Bites!",LEVEL_UP_APPLIED:"‚¨ÜÔ∏è Cheat activated! Level up applied!",HP_MP_RESTORED:"üíä Cheat activated! HP and MP fully restored!"},CONGRATULATIONS:{TITLE:"üéâ CONGRATULATIONS! üéâ",EDGE_REACHED:"You've explored to your paddy's edge!",MORE_ADVENTURES:"What lies beyond? More adventures await!",IN_DEVELOPMENT:"(In Development)",ALL_FRIENDS_TITLE:"üåü PEACE IN THE PADDIES! üåü",ALL_FRIENDS_MESSAGE:"You've made the rice paddies safe for you and all your new friends!",ALL_FRIENDS_SUBTITLE:"The waters are now peaceful and full of friendship!"},TEXT_CHECKS:{CHOOSE_COLOR_TEXT:"Choose your color",SHOP_INVENTORY_TEXT:"Fish Mart Inventory"}}}class a{static format(e,t={}){return e.replace(/\{(\w+)\}/g,(e,a)=>void 0!==t[a]?t[a]:e)}static processButtonTexts(e){const t=new Set;return e.map(e=>{for(let a=0;a<e.length;a++){const s=e[a],n=s.toLowerCase();if(n.match(/[a-z]/)&&!t.has(n))return t.add(n),{html:e.substring(0,a)+"<u>"+s+"</u>"+e.substring(a+1),key:n}}return{html:e,key:null}})}}class s{constructor(){this.audioContext=null,this.isInitialized=!1,this.isEnabled=!0}initAudio(){if(!this.isInitialized)try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.isInitialized=!0}catch(e){}}toggleAudio(){return this.isEnabled=!this.isEnabled,this.isEnabled}setAudioEnabled(e){this.isEnabled=e}isAudioEnabled(){return this.isEnabled}playSound(e){if(!this.isEnabled)return;if(this.isInitialized||this.initAudio(),!this.audioContext)return;const t=this.audioContext.createOscillator(),a=this.audioContext.createGain();switch(t.connect(a),a.connect(this.audioContext.destination),e){case"attack":t.frequency.setValueAtTime(200,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(100,this.audioContext.currentTime+.1),a.gain.setValueAtTime(.3,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.1);break;case"bubble":t.frequency.setValueAtTime(150,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(250,this.audioContext.currentTime+.1),t.frequency.exponentialRampToValueAtTime(180,this.audioContext.currentTime+.2),t.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.3),t.frequency.exponentialRampToValueAtTime(200,this.audioContext.currentTime+.4),a.gain.setValueAtTime(.15,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.08,this.audioContext.currentTime+.2),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.5),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.5);break;case"gravel":t.frequency.setValueAtTime(80,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(120,this.audioContext.currentTime+.05),t.frequency.exponentialRampToValueAtTime(60,this.audioContext.currentTime+.1),t.frequency.exponentialRampToValueAtTime(100,this.audioContext.currentTime+.15),t.frequency.exponentialRampToValueAtTime(40,this.audioContext.currentTime+.25),t.type="sawtooth",a.gain.setValueAtTime(.25,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.15,this.audioContext.currentTime+.1),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.3);break;case"party":{const e=[523,659,784,659,523,784,1047,784],t=.15;e.forEach((e,a)=>{const s=this.audioContext.createOscillator(),n=this.audioContext.createGain();s.connect(n),n.connect(this.audioContext.destination),s.type="sine",s.frequency.setValueAtTime(e,this.audioContext.currentTime+a*t),n.gain.setValueAtTime(0,this.audioContext.currentTime+a*t),n.gain.linearRampToValueAtTime(.2,this.audioContext.currentTime+a*t+.02),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+a*t+t),s.start(this.audioContext.currentTime+a*t),s.stop(this.audioContext.currentTime+a*t+t)});const a=this.audioContext.createOscillator(),s=this.audioContext.createGain();a.connect(s),s.connect(this.audioContext.destination),a.type="sine",a.frequency.setValueAtTime(800,this.audioContext.currentTime+e.length*t),a.frequency.exponentialRampToValueAtTime(1600,this.audioContext.currentTime+e.length*t+.3),s.gain.setValueAtTime(.15,this.audioContext.currentTime+e.length*t),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+e.length*t+.3),a.start(this.audioContext.currentTime+e.length*t),a.stop(this.audioContext.currentTime+e.length*t+.3);break}case"fanfare":[262,330,392,523,659,523].forEach((e,t)=>{const a=this.audioContext.createOscillator(),s=this.audioContext.createGain();a.connect(s),s.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,this.audioContext.currentTime+.12*t),s.gain.setValueAtTime(.25,this.audioContext.currentTime+.12*t),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.12*t+.2),a.start(this.audioContext.currentTime+.12*t),a.stop(this.audioContext.currentTime+.12*t+.2)});break;case"levelup":[262,294,330,349,392,440,494,523].forEach((e,t)=>{const a=this.audioContext.createOscillator(),s=this.audioContext.createGain();a.connect(s),s.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,this.audioContext.currentTime+.08*t),s.gain.setValueAtTime(.15,this.audioContext.currentTime+.08*t),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.08*t+.15),a.start(this.audioContext.currentTime+.08*t),a.stop(this.audioContext.currentTime+.08*t+.15)});break;case"combatstart":[98,98].forEach((e,t)=>{const a=this.audioContext.createOscillator(),s=this.audioContext.createGain();a.connect(s),s.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,this.audioContext.currentTime+.3*t),s.gain.setValueAtTime(.4,this.audioContext.currentTime+.3*t),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.3*t+.25),a.start(this.audioContext.currentTime+.3*t),a.stop(this.audioContext.currentTime+.3*t+.25)});break;case"wound":t.frequency.setValueAtTime(150,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(80,this.audioContext.currentTime+.15),a.gain.setValueAtTime(.2,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+.15);break;case"roar":t.frequency.setValueAtTime(60,this.audioContext.currentTime),t.frequency.exponentialRampToValueAtTime(120,this.audioContext.currentTime+.1),t.frequency.exponentialRampToValueAtTime(40,this.audioContext.currentTime+.4),t.frequency.exponentialRampToValueAtTime(80,this.audioContext.currentTime+.8),t.frequency.exponentialRampToValueAtTime(30,this.audioContext.currentTime+1.2),a.gain.setValueAtTime(.4,this.audioContext.currentTime),a.gain.setValueAtTime(.6,this.audioContext.currentTime+.1),a.gain.exponentialRampToValueAtTime(.3,this.audioContext.currentTime+.4),a.gain.exponentialRampToValueAtTime(.5,this.audioContext.currentTime+.8),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+1.5),t.type="sawtooth",t.start(this.audioContext.currentTime),t.stop(this.audioContext.currentTime+1.5);break;case"found":[392,523].forEach((e,t)=>{const a=this.audioContext.createOscillator(),s=this.audioContext.createGain();a.connect(s),s.connect(this.audioContext.destination),a.frequency.setValueAtTime(e,this.audioContext.currentTime+.15*t),s.gain.setValueAtTime(.3,this.audioContext.currentTime+.15*t),s.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15*t+.3),a.start(this.audioContext.currentTime+.15*t),a.stop(this.audioContext.currentTime+.15*t+.3)})}}}class n{constructor(){const t=e.PLAYER.STARTING_STATS;this.name="",this.color="",this.level=t.level,this.hp=t.hp,this.maxHp=t.maxHp,this.mp=t.mp,this.maxMp=t.maxMp,this.exp=t.exp,this.expToNext=e.PLAYER.PROGRESSION.EXP_BASE,this.bettaBites=t.bettaBites,this.hasDunkleosteusSub=!1,this.befriendedSpecies=new Set}takeDamage(t){if(this.hasDunkleosteusSub)return 0;let a=0;const s=e.PLAYER.ARMOR_SYSTEM.LEVELS,n=Object.keys(s).map(Number).sort((e,t)=>t-e);for(const e of n)if(this.level>=e){a=s[e].reduction;break}const i=Math.max(1,t-a);return this.hp=Math.max(0,this.hp-i),i}healHP(e){const t=Math.min(e,this.maxHp-this.hp);return this.hp=Math.min(this.maxHp,this.hp+e),t}healMP(e){const t=Math.min(e,this.maxMp-this.mp);return this.mp=Math.min(this.maxMp,this.mp+e),t}fullHeal(){const e=this.maxHp-this.hp,t=this.maxMp-this.mp;return this.hp=this.maxHp,this.mp=this.maxMp,{hpHealed:e,mpHealed:t}}levelUp(){this.level++,this.exp-=this.expToNext,this.expToNext=Math.floor(this.expToNext*e.PLAYER.PROGRESSION.EXP_MULTIPLIER);const t=e.PLAYER.PROGRESSION.HP_GAIN_PER_LEVEL,a=e.PLAYER.PROGRESSION.MP_GAIN_PER_LEVEL;return this.maxHp+=t,this.maxMp+=a,this.hp=this.maxHp,this.mp=this.maxMp,{hpIncrease:t,mpIncrease:a}}gainExp(e){return this.exp+=e,this.exp>=this.expToNext}canAfford(e){return this.bettaBites>=e}spendBettaBites(e){return!!this.canAfford(e)&&(this.bettaBites-=e,!0)}gainBettaBites(e){this.bettaBites+=e}hasSpell(t){if("bubble"===t){const t=e.COMBAT.SPELLS.BUBBLE_BLAST;return this.level>=t.unlockLevel}if("party"===t){const t=e.COMBAT.SPELLS.HAPPY_BALLOON_TIME;return this.level>=t.unlockLevel}if("gravel"===t){const t=e.COMBAT.SPELLS.GRAVEL_GRENADE;return this.level>=t.unlockLevel}return!1}canCastSpell(t){if(!this.hasSpell(t))return!1;if("bubble"===t){const t=e.COMBAT.SPELLS.BUBBLE_BLAST;return this.mp>=t.mpCost}if("party"===t){const t=e.COMBAT.SPELLS.HAPPY_BALLOON_TIME;return this.mp>=t.mpCost}if("gravel"===t){const t=e.COMBAT.SPELLS.GRAVEL_GRENADE;return this.mp>=t.mpCost}return!1}castSpell(t){return!(!this.canCastSpell(t)||("bubble"===t?(this.mp-=e.COMBAT.SPELLS.BUBBLE_BLAST.mpCost,0):"party"===t?(this.mp-=e.COMBAT.SPELLS.HAPPY_BALLOON_TIME.mpCost,0):"gravel"!==t||(this.mp-=e.COMBAT.SPELLS.GRAVEL_GRENADE.mpCost,0)))}calculateAttackDamage(){const t=e.COMBAT.PLAYER_DAMAGE;let a=Math.floor(Math.random()*(t.baseMax-t.baseMin+1))+t.baseMin+Math.floor(this.level/2);return this.hasDunkleosteusSub&&(a*=2),a}calculateMagicDamage(t){const a=Math.floor((this.level+1)/2);if("bubble"===t){const t=e.COMBAT.SPELLS.BUBBLE_BLAST,s=t.damageMin+a,n=t.damageMax+a;return Math.floor(Math.random()*(n-s+1))+s}if("party"===t){const t=e.COMBAT.SPELLS.HAPPY_BALLOON_TIME,s=t.damageMin+a,n=t.damageMax+a;return Math.floor(Math.random()*(n-s+1))+s}if("gravel"===t){const t=e.COMBAT.SPELLS.GRAVEL_GRENADE,s=t.damageMin+a,n=t.damageMax+a;return Math.floor(Math.random()*(n-s+1))+s}return 0}die(){const e=Math.floor(this.bettaBites/2);return this.bettaBites-=e,this.hp=this.maxHp,this.mp=this.maxMp,e}reset(){const t=e.PLAYER.STARTING_STATS;this.name="",this.color="",this.level=t.level,this.hp=t.hp,this.maxHp=t.maxHp,this.mp=t.mp,this.maxMp=t.maxMp,this.exp=t.exp,this.expToNext=e.PLAYER.PROGRESSION.EXP_BASE,this.bettaBites=0,this.hasDunkleosteusSub=!1}acquireSubmarine(){return this.hasDunkleosteusSub=!0,{success:!0,message:t.SHOP.CONFIRMATIONS.SUBMARINE}}hasSubmarine(){return this.hasDunkleosteusSub}get hpPercentage(){return this.hp/this.maxHp*100}get mpPercentage(){return this.mp/this.maxMp*100}getLevel(){return this.level}getExp(){return this.exp}getExpToNext(){return this.expToNext}getBettaBites(){return this.bettaBites}getHP(){return this.hp}getMaxHP(){return this.maxHp}getMP(){return this.mp}getMaxMP(){return this.maxMp}getName(){return this.name}getColor(){return this.color}addBefriendedSpecies(e){this.befriendedSpecies.add(e)}isFriendsWith(e){return this.befriendedSpecies.has(e)}setPlayerIdentity(e,t){this.name=e,this.color=t}get isAlive(){return this.hp>0}getSprite(){if(this.hasDunkleosteusSub)return`graphics/artifacts/${e.PLAYER.ARMOR_SYSTEM.SUBMARINE.sprite}`;const t=e.PLAYER.ARMOR_SYSTEM.LEVELS,a=Object.keys(t).map(Number).sort((e,t)=>t-e);for(const e of a)if(this.level>=e)return`graphics/main_fish/${t[e].sprite}`;return`graphics/main_fish/${t[1].sprite}`}getColorFilter(){const t=e.UI.COLORS[this.color?.toUpperCase()];return t?t.filter:"none"}}class i{constructor(){this.npcs={elder:{name:t.NPCS.ELDER_FINN.NAME,dialogues:t.NPCS.ELDER_FINN.DIALOGUES},merchant:{name:t.NPCS.SHOPKEEPER_CORAL.NAME,dialogues:t.NPCS.SHOPKEEPER_CORAL.DIALOGUES,isShop:!0},guard:{name:t.NPCS.GUARD_CAPTAIN_REEF.NAME,dialogues:t.NPCS.GUARD_CAPTAIN_REEF.DIALOGUES},bubble:{name:t.NPCS.BUBBLE_THE_BRAVE.NAME,dialogues:t.NPCS.BUBBLE_THE_BRAVE.DIALOGUES},innkeeper:{name:t.NPCS.INNKEEPER_SEAWEED.NAME,dialogues:t.NPCS.INNKEEPER_SEAWEED.DIALOGUES,isInn:!0}},this.currentNPC=null,this.currentDialogueIndex=0}talkToNPC(t){const s=this.npcs[t];if(!s)return{success:!1,message:"NPC not found!"};this.currentNPC=t,this.currentDialogueIndex=0;const n=s.dialogues[this.currentDialogueIndex];let i=n;return s.isShop?i=a.format(n,{cost:e.SHOP.SUBMARINE.cost}):s.isInn&&(i=a.format(n,{cost:e.SHOP.INN_REST.cost})),{success:!0,npc:s,dialogue:i,isShop:s.isShop||!1,isInn:s.isInn||!1,hasMoreDialogue:this.currentDialogueIndex<s.dialogues.length-1}}nextDialogue(){if(!this.currentNPC)return{success:!1};const t=this.npcs[this.currentNPC];if(this.currentDialogueIndex++,this.currentDialogueIndex>=t.dialogues.length)return{success:!0,finished:!0,isShop:t.isShop||!1,isInn:t.isInn||!1};const s=t.dialogues[this.currentDialogueIndex];let n=s;return t.isShop?n=a.format(s,{cost:e.SHOP.SUBMARINE.cost}):t.isInn&&(n=a.format(s,{cost:e.SHOP.INN_REST.cost})),{success:!0,npc:t,dialogue:n,isShop:t.isShop||!1,isInn:t.isInn||!1,hasMoreDialogue:this.currentDialogueIndex<t.dialogues.length-1}}endDialogue(){return this.currentNPC=null,this.currentDialogueIndex=0,{success:!0}}getCurrentDialogueState(){if(!this.currentNPC)return null;const e=this.npcs[this.currentNPC];return{npcId:this.currentNPC,npc:e,dialogueIndex:this.currentDialogueIndex,isShop:e.isShop||!1,isInn:e.isInn||!1,hasMoreDialogue:this.currentDialogueIndex<e.dialogues.length-1}}reset(){this.currentNPC=null,this.currentDialogueIndex=0}}class o{constructor(t,a){this.player=t,this.audio=a,this.world=null,this.ui=null,this.currentEnemy=null,this.defeatedEnemy=null,this.combatLog=[],this.combatActive=!1,this.hasDefeatedGar=!1,this.garTurnCounter=0,this.lastVictoryWasLevel10=!1,this.hasReachedEdge=!1,this.levelUpTimeout=null,this.playerHasPartyHat=!1,this.currentCombatBefriending=!1,this.hasAchievedPeace=!1,this.enemies=[this.createEnemyFromConfig(e.ENEMIES.AGGRESSIVE_GUPPY),this.createEnemyFromConfig(e.ENEMIES.TERRITORIAL_ANGELFISH),this.createEnemyFromConfig(e.ENEMIES.SNEAKY_CATFISH),this.createEnemyFromConfig(e.ENEMIES.FIERCE_CICHLID),this.createEnemyFromConfig(e.ENEMIES.PREHISTORIC_GAR)]}createEnemyFromConfig(e){return{name:e.name,hp:e.baseHp,maxHp:e.baseHp,attack:e.baseDamage,exp:e.baseExp,sprite:`graphics/enemies/${e.sprite}`,attacks:e.attacks}}setWorldManager(e){this.world=e}setUIManager(e){this.ui=e}calculateEnemyLevel(t,a){const s=this.world.getDistanceFromVillage(t,a),n=e.WORLD.DANGER_ZONES;let i;return i=s<=n.SAFE_RADIUS?n.LEVEL_SCALING.SAFE:s<=n.DANGEROUS_RADIUS?n.LEVEL_SCALING.DANGEROUS:n.LEVEL_SCALING.EXTREME,Math.floor(Math.random()*(i.max-i.min+1))+i.min}scaleEnemyWithLevel(t,a){const s={name:t.name,hp:t.hp,maxHp:t.maxHp,attack:t.attack,exp:t.exp,sprite:t.sprite,attacks:[...t.attacks]},n=e.COMBAT.ENEMY_SCALING,i=n.HP_BASE_MULTIPLIER+(a-1)*n.HP_LEVEL_MULTIPLIER;s.hp=Math.floor(t.hp*i),s.maxHp=s.hp;const o=n.DAMAGE_BASE_MULTIPLIER+(a-1)*n.DAMAGE_LEVEL_MULTIPLIER;s.attack=Math.floor(t.attack*o);const r=1+(a-1)*e.COMBAT.ENEMY_SCALING.EXP_LEVEL_MULTIPLIER;return s.exp=Math.floor(t.exp*r),s}startRandomEncounter(s,n){let i;const o=this.calculateEnemyLevel(s,n);if(this.world.getDistanceFromVillage(s,n)>e.WORLD.DANGER_ZONES.DANGEROUS_RADIUS&&!this.hasDefeatedGar)i=4;else{const e=10;for(let t=0;t<e;t++){i=Math.floor(4*Math.random());const a=this.enemies[i].name;if(!this.player.isFriendsWith(a))break;if(t===e-1)return null}}const r=this.enemies[i];this.currentEnemy=this.scaleEnemyWithLevel(r,o),this.currentEnemy.level=o,this.currentEnemy.randomHue=Math.floor(360*Math.random()),this.combatActive=!0,this.garTurnCounter=0,this.currentCombatBefriending=!1;const l=document.getElementById("player-fish-combat");l&&(l.style.transform="none");const c=document.getElementById("stats-player-sprite");c&&(c.style.transform="none");const h=document.getElementById("enemy-fish-combat");return h&&(h.style.transform="scaleX(-1)"),this.audio.playSound("combatstart"),this.addToCombatLog(a.format(t.COMBAT.COMBAT_BEGINS,{playerName:this.player.getName(),enemyName:this.currentEnemy.name})),this.currentEnemy}attack(){if(!this.combatActive||!this.currentEnemy)return;const e=this.player.calculateAttackDamage();this.currentEnemy.hp=Math.max(0,this.currentEnemy.hp-e);const a=t.COMBAT.ATTACK_DESCRIPTIONS,s=a[Math.floor(Math.random()*a.length)];return this.audio.playSound("attack"),this.addToCombatLog(`${this.player.getName()} ${s} for ${e} damage!`),this.shakeEnemySprite(),this.checkForVictory()}useSkill(e){if(this.combatActive&&this.currentEnemy&&this.player.canCastSpell(e)){if(this.player.castSpell(e),this.audio.playSound(e),"bubble"===e){const a=this.player.calculateMagicDamage(e);this.currentEnemy.hp=Math.max(0,this.currentEnemy.hp-a),this.shakeEnemySprite();const s=t.COMBAT.BUBBLE_DESCRIPTIONS,n=s[Math.floor(Math.random()*s.length)];this.createBubbleEffect(),this.addToCombatLog(`${this.player.getName()} ${n} for ${a} damage!`)}else if("party"===e)this.createBalloonEffect(),this.addPartyHatToEnemy(),this.addPartyHatToPlayer(),this.applyRainbowHP(),this.addToCombatLog(`${this.player.getName()} throws a magical party!`),this.addToCombatLog(`${this.currentEnemy.name} is having such a good time!`),this.currentEnemy.befriended=!0,this.currentCombatBefriending=!0,this.currentEnemy.hp=1;else if("gravel"===e){const a=this.player.calculateMagicDamage(e);this.currentEnemy.hp=Math.max(0,this.currentEnemy.hp-a),this.shakeEnemySprite();const s=t.COMBAT.GRAVEL_DESCRIPTIONS,n=s[Math.floor(Math.random()*s.length)];this.createGravelEffect(),this.addToCombatLog(`${this.player.getName()} ${n} for ${a} damage!`)}return this.checkForVictory()}}checkForVictory(){if(this.currentEnemy.hp<=0||this.currentEnemy.befriended){this.combatActive=!1,this.defeatedEnemy={...this.currentEnemy};const e=this.processVictoryImmediate(this.defeatedEnemy);return{enemyDefeated:!0,enemy:this.defeatedEnemy,victoryResult:e}}return this.enemyTurn(),this.player.isAlive?null:{playerDefeated:!0}}enemyTurn(){if(!this.combatActive||!this.currentEnemy)return;if("Prehistoric Gar"===this.currentEnemy.name&&this.garTurnCounter++,"Prehistoric Gar"===this.currentEnemy.name){const t=e.ENEMIES.PREHISTORIC_GAR.special;if(t.gargantuanAttack&&this.garTurnCounter===t.gargantuanAttack.turn)return void this.executeGargantuanAttack(t.gargantuanAttack);if(t.roarTurns&&t.roarTurns.includes(this.garTurnCounter))return void this.executeGarRoar(t)}const s=Math.floor(Math.random()*this.currentEnemy.attacks.length),n=this.currentEnemy.attacks[s],i=this.player.takeDamage(this.currentEnemy.attack);0===i&&this.player.hasSubmarine()?(this.addToCombatLog(a.format(t.COMBAT.ENEMY_ATTACK_DEFLECTED,{enemyName:this.currentEnemy.name,attackDescription:n})),this.audio.playSound("attack")):(this.audio.playSound("wound"),this.addToCombatLog(a.format(t.COMBAT.ENEMY_ATTACK_DAMAGE,{enemyName:this.currentEnemy.name,attackDescription:n,damage:i})),this.shakePlayerSprite())}executeGargantuanAttack(e){this.addToCombatLog(e.channelMessage),this.addToCombatLog(e.attackMessage),this.audio.playSound(e.sound),"giant_gar"===e.visualEffect&&this.createGiantGarEffect(),setTimeout(()=>{if(this.player.hasSubmarine())this.addToCombatLog(e.defenseMessage),this.audio.playSound("attack");else{this.player.takeDamage(e.damage);const t=a.format(e.damageMessage,{damage:e.damage});this.addToCombatLog(t),this.audio.playSound("wound"),this.shakePlayerSprite(),this.player.isAlive||this.ui&&this.ui.checkAndHandlePlayerDefeat()}},e.delay)}executeGarRoar(e){const a=t.COMBAT.PREHISTORIC_GAR_ROAR;this.addToCombatLog(a),this.audio.playSound(e.roarSound)}runAway(){if(!this.combatActive)return{escaped:!1};const a=e.COMBAT.RUN_AWAY;return this.currentEnemy.level>=a.difficultEnemyLevel&&Math.random()>a.difficultEscapeChance?(this.addToCombatLog(t.COMBAT.ESCAPE_FAILED),this.enemyTurn(),this.player.isAlive?{escaped:!1}:{escaped:!1,playerDefeated:!0}):(this.combatActive=!1,this.currentEnemy=null,this.addToCombatLog(t.COMBAT.ESCAPE_BARELY_SUCCESS),{escaped:!0})}completeEnemyDefeat(e){const t=this.defeatedEnemy;t?(this.defeatedEnemy=null,setTimeout(()=>{const a=this.winCombatWithEnemy(t);a.defeatedEnemy=t,e&&e(a)},500)):console.error("completeEnemyDefeat called but no defeated enemy stored")}processVictoryImmediate(s){const n=s.exp;if(!s.befriended){const e=document.getElementById("enemy-fish-combat");e&&(e.style.transform="scaleX(-1) scaleY(-1)")}const i=e.COMBAT.ENEMY_SCALING.BETTA_BITES_REWARDS,o=Math.floor(Math.random()*(i.baseMax-i.baseMin+1))+i.baseMin,r=Math.floor(Math.random()*(i.levelBonusMax-i.levelBonusMin+1))+i.levelBonusMin,l=o+(s.level-1)*r;"Prehistoric Gar"===s.name&&s.level>=8&&(this.hasDefeatedGar=!0,!this.hasAchievedPeace&&this.areAllEnemiesPeaceful()&&(this.hasAchievedPeace=!0)),this.player.gainExp(n),this.player.gainBettaBites(l),s.befriended?(this.player.addBefriendedSpecies(s.name),this.addToCombatLog(`${s.name} becomes your friend! You gained ${n} EXP and ${l} Betta Bites!`),!this.hasAchievedPeace&&this.areAllEnemiesPeaceful()&&(this.hasAchievedPeace=!0)):this.addToCombatLog(a.format(t.COMBAT.VICTORY_REWARDS,{exp:n,bettaBites:l}));const c=this.player.gainExp(0),h=e.WORLD.DANGER_ZONES.LEVEL_SCALING.EXTREME.min,d=s.level===h&&!this.hasReachedEdge;return d&&(this.hasReachedEdge=!0),this.lastVictoryWasLevel10=d,this.audio.playSound("fanfare"),c&&(this.addToCombatLog(a.format(t.COMBAT.LEVEL_UP,{newLevel:this.player.getLevel()+1})),this.levelUpTimeout=setTimeout(()=>{const s=this.player.levelUp();this.addToCombatLog(a.format(t.COMBAT.HP_MP_INCREASE,{hpIncrease:s.hpIncrease,mpIncrease:s.mpIncrease}));const n=e.PLAYER.ARMOR_SYSTEM.LEVELS;if(n[this.player.getLevel()]){const e=Object.keys(n).map(Number).sort().indexOf(this.player.getLevel()),a=[null,t.COMBAT.ARMOR_HELMET,t.COMBAT.ARMOR_ADVANCED,t.COMBAT.ARMOR_FULL_METAL];e>=0&&e<a.length&&a[e]&&this.addToCombatLog(a[e])}this.audio.playSound("levelup"),this.levelUpTimeout=null},500)),{victory:!0,showCongratulations:d,showPeaceMessage:this.hasAchievedPeace,levelUp:c}}winCombatWithEnemy(e){return e?(this.currentEnemy=null,{victory:!0,showCongratulations:this.lastVictoryWasLevel10,showPeaceMessage:!1}):(console.error("winCombatWithEnemy called with null enemy"),{victory:!1})}loseCombat(){const e=this.currentEnemy?{...this.currentEnemy}:null,s=this.player.die(),n=document.getElementById("player-fish-combat");n&&(n.style.transform="scaleY(-1)");const i=document.getElementById("stats-player-sprite");return i&&(i.style.transform="scaleY(-1)"),this.addToCombatLog(t.COMBAT.PLAYER_DEFEATED),s>0&&this.addToCombatLog(a.format(t.COMBAT.PLAYER_LOST_BETTA_BITES,{amount:s})),this.combatActive=!1,this.currentEnemy=null,{defeated:!0,bettaBitesLost:s,defeatedByEnemy:e}}createBubbleEffect(){const e=[4,5,6,7,8],t=e[Math.floor(Math.random()*e.length)];for(let e=0;e<t;e++)setTimeout(()=>{const e=document.createElement("div");e.className="bubble",e.style.cssText=`\n                    position: absolute;\n                    width: ${15*Math.random()+10}px;\n                    height: ${15*Math.random()+10}px;  \n                    background: radial-gradient(circle, lightblue, rgba(173,216,230,0.8));\n                    border-radius: 50%;\n                    left: ${90*Math.random()+5}%;\n                    top: 100%;\n                    pointer-events: none;\n                    z-index: 9998;\n                    animation: bubble-rise 2s ease-out forwards;\n                `,document.getElementById("game-container").appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},2e3)},150*e)}createGravelEffect(){const e=document.createElement("div");e.className="gravel-container",e.style.cssText="\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            pointer-events: none;\n            z-index: 1000;\n        ",document.getElementById("game-container").appendChild(e);const t=Math.floor(15*Math.random())+20;for(let a=0;a<t;a++)setTimeout(()=>{const t=document.createElement("div");t.className="gravel-particle",t.style.cssText=`\n                    position: absolute;\n                    width: ${8*Math.random()+4}px;\n                    height: ${8*Math.random()+4}px;\n                    background: linear-gradient(45deg, #8B4513, #A0522D, #696969);\n                    border-radius: ${3*Math.random()}px;\n                    left: ${100*Math.random()}%;\n                    top: -20px;\n                    animation: gravelFall ${.5*Math.random()+1}s ease-in forwards;\n                `,e.appendChild(t)},50*a);setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},2e3)}createBalloonEffect(){const e=document.createElement("div");e.className="balloon-container",e.dataset.createdAt=Date.now(),e.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100vw;\n            height: 100vh;\n            pointer-events: none;\n            z-index: 9998;\n        ",document.getElementById("game-container").appendChild(e);const t=Math.floor(10*Math.random())+15,a=["#FF69B4","#FFD700","#87CEEB","#98FB98","#DDA0DD","#F0E68C","#FF6347","#40E0D0"];for(let s=0;s<t;s++)setTimeout(()=>{const t=document.createElement("div");t.className="party-balloon";const s=a[Math.floor(Math.random()*a.length)],n=30*Math.random()+25,i=100*Math.random();t.style.cssText=`\n                    position: absolute;\n                    width: ${1.2*n}px;\n                    height: ${1.5*n}px;\n                    background: radial-gradient(ellipse at 35% 25%, ${s}ee, ${s}cc, ${s}aa);\n                    border-radius: 50%;\n                    left: ${i}%;\n                    bottom: -100px;\n                    opacity: 0.85;\n                    animation: balloon-smooth-rise ${2*Math.random()+4}s linear forwards;\n                    box-shadow: 0 3px 15px rgba(0,0,0,0.15), inset -5px -5px 10px rgba(255,255,255,0.3);\n                `;const o=document.createElement("div");o.style.cssText="\n                    position: absolute;\n                    width: 1px;\n                    height: 50px;\n                    background: #666;\n                    left: 50%;\n                    top: 100%;\n                    transform: translateX(-50%);\n                ",t.appendChild(o),e.appendChild(t)},100*s);setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},6500)}createGiantGarEffect(){const e=document.createElement("img");e.src="graphics/enemies/prehistoric_gar.png",e.style.cssText=`\n            position: fixed;\n            top: 30vh;\n            right: -600px;\n            width: 600px;\n            height: 300px;\n            z-index: 9999;\n            image-rendering: pixelated;\n            filter: hue-rotate(${this.currentEnemy.randomHue}deg);\n            animation: giant-gar-swim 3s ease-in-out forwards;\n        `,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}getPartyHatSprite(e){if(!e)return null;const t=e.split("/"),a=t.pop().replace(".png","");return`${t.join("/")}/partyhat/${a}_partyhat.png`}addPartyHatToEnemy(){const e=document.getElementById("enemy-fish-combat");if(!e||!this.currentEnemy)return;const t=this.getPartyHatSprite(this.currentEnemy.sprite);t&&(e.src=t,this.currentEnemy.hasPartyHat=!0)}addPartyHatToPlayer(){this.playerHasPartyHat=!0,this.ui&&this.ui.updatePlayerSpritesWithPartyHat()}applyRainbowHP(){this.ui&&this.ui.applyRainbowHPEffect()}addToCombatLog(e){this.combatLog.unshift(e),this.combatLog.length>10&&(this.combatLog=this.combatLog.slice(0,10))}shakeSprite(e,t=500){const a=document.getElementById(e);a&&(a.classList.add("shake"),setTimeout(()=>{a.classList.remove("shake")},t))}shakePlayerSprite(){this.shakeSprite("player-fish-combat"),this.shakeSprite("stats-player-sprite")}shakeEnemySprite(){this.shakeSprite("enemy-fish-combat")}reset(){this.currentEnemy=null,this.defeatedEnemy=null,this.combatLog=[],this.combatActive=!1,this.hasDefeatedGar=!1,this.garTurnCounter=0,this.lastVictoryWasLevel10=!1,this.hasReachedEdge=!1,this.playerHasPartyHat=!1,this.currentCombatBefriending=!1,this.hasAchievedPeace=!1,this.levelUpTimeout&&(clearTimeout(this.levelUpTimeout),this.levelUpTimeout=null)}getCombatLog(){return this.combatLog}getCurrentEnemy(){return this.currentEnemy}isCombatActive(){return this.combatActive}shouldShowCongratulations(){return this.lastVictoryWasLevel10}clearCongratulationsFlag(){this.lastVictoryWasLevel10=!1}shouldShowPeaceMessage(){return this.hasAchievedPeace}clearPeaceMessageFlag(){this.hasAchievedPeace=!1}isBefriendingCurrentEnemy(){return this.currentCombatBefriending}areAllEnemiesPeaceful(){if(!this.hasDefeatedGar)return!1;const e=["Aggressive Guppy","Territorial Angelfish","Sneaky Catfish","Fierce Cichlid"];for(const t of e)if(!this.player.isFriendsWith(t))return!1;return!0}displayCombatMessage(e){this.addToCombatLog(e)}processCombatVictory(e){this.completeEnemyDefeat(e)}}class r{constructor(t,a,s,n){this.player=t,this.audio=a,this.combat=s,this.npcs=n,this.currentX=e.WORLD.VILLAGE_CENTER.x,this.currentY=e.WORLD.VILLAGE_CENTER.y,this.inVillage=!0,this.WORLD_SIZE=e.WORLD.MAP_SIZE,this.VILLAGE_CENTER=e.WORLD.VILLAGE_CENTER,this.ENCOUNTER_RATES=e.WORLD.ENCOUNTER_RATES}movePlayer(e){let a=this.currentX,s=this.currentY;switch(e){case"north":s--;break;case"south":s++;break;case"east":a++;break;case"west":a--}a=Math.max(1,Math.min(this.WORLD_SIZE-2,a)),s=Math.max(1,Math.min(this.WORLD_SIZE-2,s)),this.currentX=a,this.currentY=s;const n=this.inVillage;return this.inVillage=a===this.VILLAGE_CENTER.x&&s===this.VILLAGE_CENTER.y,!n&&this.inVillage?{success:!0,message:t.EXPLORATION.VILLAGE_MESSAGES.RETURN_TO_SAFETY,location:this.getCurrentLocation()}:this.inVillage?{success:!0,location:this.getCurrentLocation()}:{success:!0,encounter:this.checkForEncounter(),location:this.getCurrentLocation()}}checkForEncounter(){if(this.getDistanceFromVillage()>e.WORLD.DANGER_ZONES.DANGEROUS_RADIUS)return this.createCombatEncounter();const t=Math.random(),a=this.ENCOUNTER_RATES;return t<a.COMBAT?this.createCombatEncounter():t<a.COMBAT+a.TREASURE?this.createTreasureEncounter():t<a.COMBAT+a.TREASURE+a.PEACEFUL?this.createPeacefulEncounter():this.createMysteryEncounter()}createCombatEncounter(){const a=this.combat.startRandomEncounter(this.currentX,this.currentY);if(!a)return{type:"peaceful",message:"Your fish friends swim by peacefully!",effectMessage:null};let s=null;return this.getDistanceFromVillage()>e.WORLD.DANGER_ZONES.DANGEROUS_RADIUS&&(s=t.EXPLORATION.DANGER_WARNINGS.EDGE_ZONE),{type:"combat",enemy:a,message:s}}createTreasureEncounter(){const s=e.ECONOMY.INCOME_SOURCES.TREASURE_BASE,n=Math.floor(Math.random()*(s.max-s.min+1))+s.min;this.player.gainBettaBites(n),this.audio.playSound("found");const i=t.EXPLORATION.ENCOUNTERS.TREASURE,o=i[Math.floor(Math.random()*i.length)];return{type:"treasure",amount:n,message:a.format(o,{amount:n})}}createPeacefulEncounter(){const e=t.EXPLORATION.ENCOUNTERS.PEACEFUL;return{type:"peaceful",message:e[Math.floor(Math.random()*e.length)]}}createMysteryEncounter(){const e=t.EXPLORATION.ENCOUNTERS.MYSTERY;return{type:"mystery",message:e[Math.floor(Math.random()*e.length)]}}getCurrentLocation(){return{x:this.currentX,y:this.currentY,inVillage:this.inVillage}}enterVillage(){return this.currentX===this.VILLAGE_CENTER.x&&this.currentY===this.VILLAGE_CENTER.y?(this.inVillage=!0,{success:!0,message:t.EXPLORATION.VILLAGE_MESSAGES.WELCOME_TO_VILLAGE}):{success:!1,message:t.EXPLORATION.VILLAGE_MESSAGES.NEED_TO_BE_AT_CENTER}}leaveVillage(){return this.inVillage?(this.currentX=this.VILLAGE_CENTER.x,this.currentY=this.VILLAGE_CENTER.y+1,this.inVillage=!1,{success:!0,message:t.EXPLORATION.MOVEMENT.VILLAGE_EXIT}):{success:!1,message:t.EXPLORATION.VILLAGE_MESSAGES.ALREADY_OUTSIDE}}getShopItems(){return[{name:t.SHOP.ITEMS.SUBMARINE.NAME,description:t.SHOP.ITEMS.SUBMARINE.DESCRIPTION,cost:e.SHOP.SUBMARINE.cost,id:e.SHOP.SUBMARINE.id},{name:t.SHOP.ITEMS.KELP_SNACK.NAME,description:t.SHOP.ITEMS.KELP_SNACK.DESCRIPTION,cost:e.SHOP.KELP_SNACK.cost,id:e.SHOP.KELP_SNACK.id},{name:t.SHOP.ITEMS.BUBBLE_WATER.NAME,description:t.SHOP.ITEMS.BUBBLE_WATER.DESCRIPTION,cost:e.SHOP.BUBBLE_WATER.cost,id:e.SHOP.BUBBLE_WATER.id}]}buyItem(e){const s=this.getShopItems().find(t=>t.id===e);if(!s)return{success:!1,message:t.SHOP.ERRORS.ITEM_NOT_FOUND};if(!this.player.canAfford(s.cost))return{success:!1,message:t.SHOP.ERRORS.NOT_ENOUGH_BETTA_BITES};switch(this.player.spendBettaBites(s.cost),e){case"submarine":return this.player.acquireSubmarine();case"kelp_snack":{const e=this.player.healHP(this.player.getMaxHP());return{success:!0,message:a.format(t.SHOP.CONFIRMATIONS.KELP_SNACK,{hpHealed:e})}}case"bubble_water":{const e=this.player.healMP(this.player.getMaxMP());return{success:!0,message:a.format(t.SHOP.CONFIRMATIONS.BUBBLE_WATER,{mpRestored:e})}}}return{success:!1,message:t.SHOP.ERRORS.UNKNOWN_ITEM_EFFECT}}getDistanceFromVillage(e=this.currentX,t=this.currentY){return Math.sqrt((e-this.VILLAGE_CENTER.x)*(e-this.VILLAGE_CENTER.x)+(t-this.VILLAGE_CENTER.y)*(t-this.VILLAGE_CENTER.y))}talkToNPC(e){return this.npcs.talkToNPC(e)}nextDialogue(){return this.npcs.nextDialogue()}restAtInn(){const s=e.SHOP.INN_REST.cost;return this.player.canAfford(s)?(this.player.spendBettaBites(s),this.player.fullHeal(),{success:!0,message:t.INN.CONFIRMATION}):{success:!1,message:a.format(t.SHOP.ERRORS.INSUFFICIENT_FUNDS_FOR_REST,{cost:s})}}endDialogue(){return this.npcs.endDialogue()}getCurrentDialogueState(){return this.npcs.getCurrentDialogueState()}teleportToVillage(){return this.currentX=this.VILLAGE_CENTER.x,this.currentY=this.VILLAGE_CENTER.y,this.inVillage=!0,{success:!0,message:t.EXPLORATION.VILLAGE_MESSAGES.SAFELY_RETURNED}}reset(){this.currentX=this.VILLAGE_CENTER.x,this.currentY=this.VILLAGE_CENTER.y,this.inVillage=!0,this.npcs.reset()}isInVillage(){return this.inVillage}}class l{constructor(e,a,s,n){this.player=e,this.audio=a,this.combat=s,this.world=n,this.core=null,this.isShowingConfirmation=!1,this.currentScreen="start",this.shopOpen=!1,this.cachedWorldBackground=null,this.cachedWaterTiles=null,this.backgroundPreRenderComplete=!1,this.dialogueActive=!1,this.blockVillageExit=!1,this.defeatInProgress=!1,this.ricePaddyPositions=this.generateRicePaddyPositions(),this.playerMapPosition={x:50,y:50},this.playerFacing="right",this.bettaNames=t.CHARACTER_CREATION.RANDOM_NAMES,this.initializeUI(),this.setupEventDelegation(),setTimeout(()=>this.initializeVillageBackground(),0)}setCoreManager(e){this.core=e,this.setupVersionInfo()}setupVersionInfo(){const t=document.getElementById("version-info");if(t)if(this.core){const e=this.core.getVersion();t.innerHTML=`<a href="${e.website}" target="_blank">v${e.version}</a>`}else t.innerHTML=`<a href="${e.GAME.WEBSITE}" target="_blank">v${e.GAME.VERSION}</a>`}generateRandomName(){const e=Math.floor(Math.random()*this.bettaNames.length);return this.bettaNames[e]}isButtonVisible(e){const t=document.getElementById(e);return t&&"none"!==t.style.display&&!t.disabled}attack(){if(this.combat.isCombatActive()){const e=this.combat.attack();this.updateCombatDisplay(),e&&e.enemyDefeated&&this.handleCombatVictory(e)}}useSkill(e){if(this.combat.isCombatActive()){const t=this.combat.useSkill(e);this.updateCombatDisplay(),t&&t.enemyDefeated&&this.handleCombatVictory(t)}}swimAway(){this.combat.isCombatActive()&&(this.combat.runAway()&&this.showWorldMap(),this.updateCombatDisplay())}buyItem(e){const s=this.world.buyItem(e),n=document.getElementById("dialogue-text"),i=document.getElementById("dialogue-options");if(n&&i)if(this.isShowingConfirmation=!0,"submarine"===e){n.textContent=t.SHOP.CONFIRMATIONS.SUBMARINE;const[e]=a.processButtonTexts([t.UI.BUTTONS.AMAZING]);i.innerHTML=`<div class="dialogue-option" data-action="end-confirmation">${e.html}</div>`}else{n.textContent=s.message;const[e]=a.processButtonTexts([t.UI.BUTTONS.THANKS]);i.innerHTML=`<div class="dialogue-option" data-action="end-confirmation">${e.html}</div>`}}initializeUI(){this.setupEventListeners(),this.initializeStrings(),this.showStartScreen(),this.updateAllDisplays(),this.setupVersionInfo()}initializeStrings(){const e=document.getElementById("village-title");e&&(e.textContent=t.LOCATIONS.VILLAGE.NAME);const s=document.getElementById("world-map-title");s&&(s.textContent=t.LOCATIONS.WORLD_MAP.NAME);const n=document.getElementById("combat-title");n&&(n.textContent=t.UI.SCREENS.COMBAT_TITLE);const i=document.getElementById("village-description");i&&(i.textContent=t.LOCATIONS.VILLAGE.DESCRIPTION);const o=document.getElementById("world-map-description");o&&(o.textContent=t.LOCATIONS.WORLD_MAP.DESCRIPTION),this.villageButtons=a.processButtonTexts([t.LOCATIONS.VILLAGE.BUILDINGS.ELDER_DWELLING,t.LOCATIONS.VILLAGE.BUILDINGS.FISH_MART,t.LOCATIONS.VILLAGE.BUILDINGS.VILLAGE_GUARD,t.LOCATIONS.VILLAGE.BUILDINGS.BUBBLES_HOME,t.LOCATIONS.VILLAGE.BUILDINGS.SWISHY_SOLACE_INN,t.LOCATIONS.VILLAGE.BUILDINGS.EXIT_TO_PADDIES]);const r=document.getElementById("elder-dwelling");r&&(r.innerHTML=this.villageButtons[0].html);const l=document.getElementById("fish-mart");l&&(l.innerHTML=this.villageButtons[1].html);const c=document.getElementById("village-guard");c&&(c.innerHTML=this.villageButtons[2].html);const h=document.getElementById("bubbles-home");h&&(h.innerHTML=this.villageButtons[3].html);const d=document.getElementById("swishy-solace-inn");d&&(d.innerHTML=this.villageButtons[4].html);const u=document.getElementById("exit-to-paddies");u&&(u.innerHTML=this.villageButtons[5].html);const m=document.getElementById("attack-btn");if(m){const[e]=a.processButtonTexts([t.UI.BUTTONS.ATTACK]);m.innerHTML=e.html,m.dataset.key=e.key}const E=document.getElementById("swim-away-btn");if(E){const[e]=a.processButtonTexts([t.UI.BUTTONS.SWIM_AWAY]);E.innerHTML=e.html,E.dataset.key=e.key}const p=a.processButtonTexts([t.LOCATIONS.WORLD_MAP.MOVEMENT.SWIM_NORTH,t.LOCATIONS.WORLD_MAP.MOVEMENT.SWIM_SOUTH,t.LOCATIONS.WORLD_MAP.MOVEMENT.SWIM_EAST,t.LOCATIONS.WORLD_MAP.MOVEMENT.SWIM_WEST,t.LOCATIONS.WORLD_MAP.MOVEMENT.RETURN_TO_VILLAGE]),g=document.getElementById("swim-north-btn");g&&(g.innerHTML=p[0].html,g.dataset.key=p[0].key);const y=document.getElementById("swim-south-btn");y&&(y.innerHTML=p[1].html,y.dataset.key=p[1].key);const T=document.getElementById("swim-east-btn");T&&(T.innerHTML=p[2].html,T.dataset.key=p[2].key);const S=document.getElementById("swim-west-btn");S&&(S.innerHTML=p[3].html,S.dataset.key=p[3].key);const A=document.getElementById("return-village-btn");A&&(A.innerHTML=p[4].html,A.dataset.key=p[4].key),this.updateSpellButtons();const C=document.querySelector('label[for="betta-name"]');C&&(C.textContent=t.UI.LABELS.NAME_YOUR_BETTA);const b=document.getElementById("betta-name");b&&(b.placeholder=t.UI.LABELS.ENTER_NAME);const I=document.getElementById("random-name-btn");if(I){const[e]=a.processButtonTexts([t.UI.BUTTONS.NEW_NAME]);I.innerHTML=e.html,I.dataset.key=e.key}document.querySelectorAll("label").forEach(e=>{e.textContent.includes(t.SYSTEM.TEXT_CHECKS.CHOOSE_COLOR_TEXT)&&(e.textContent=t.UI.LABELS.CHOOSE_COLOR)});const L=document.getElementById("create-character");if(L){const[e]=a.processButtonTexts([t.UI.BUTTONS.START_GAME]);L.innerHTML=e.html,L.dataset.key=e.key,L.disabled=!0}const f=document.querySelector("#character-preview p:first-child");f&&f.textContent.startsWith("Name:")&&(f.innerHTML=`${t.UI.LABELS.NAME_PREVIEW} <span id="preview-name">${t.UI.LABELS.UNKNOWN_NAME}</span>`);const N=document.querySelector("#character-preview p:last-child");N&&N.textContent.startsWith("Color:")&&(N.innerHTML=`${t.UI.LABELS.COLOR_PREVIEW} <span id="preview-color">${t.UI.LABELS.CHOOSE_A_COLOR}</span>`);const R=document.querySelectorAll(".color-option"),B=[],M={};R.forEach(e=>{const a=e.dataset.color;"red"===a?(B.push(t.UI.COLORS.RED),M.red=B.length-1):"blue"===a?(B.push(t.UI.COLORS.BLUE),M.blue=B.length-1):"purple"===a?(B.push(t.UI.COLORS.PURPLE),M.purple=B.length-1):"green"===a?(B.push(t.UI.COLORS.GREEN),M.green=B.length-1):"orange"===a&&(B.push(t.UI.COLORS.ORANGE),M.orange=B.length-1)});const O=a.processButtonTexts(B);R.forEach(e=>{const t=e.dataset.color,a=M[t];void 0!==a&&(e.innerHTML=O[a].html,e.dataset.key=O[a].key)});const _=document.querySelector("#congratulations-popup h1");_&&(_.textContent=t.SYSTEM.CONGRATULATIONS.TITLE);const P=document.querySelector("#congratulations-popup p:nth-of-type(1)");P&&(P.textContent=t.SYSTEM.CONGRATULATIONS.EDGE_REACHED);const v=document.querySelector("#congratulations-popup p.subtitle");v&&(v.textContent=t.SYSTEM.CONGRATULATIONS.MORE_ADVENTURES);const x=document.querySelector("#congratulations-popup p.dev-note");x&&(x.textContent=t.SYSTEM.CONGRATULATIONS.IN_DEVELOPMENT),this.setupVersionInfo();const[D]=a.processButtonTexts([t.UI.BUTTONS.CONTINUE_SWIMMING]),w=document.getElementById("close-popup");w&&(w.innerHTML=D.html,w.dataset.key=D.key);const k=document.querySelector("#title-screen h1");k&&(k.textContent=t.UI.SCREENS.TITLE);const U=document.querySelector("#title-screen p");U&&(U.textContent=t.UI.SCREENS.SUBTITLE);const H=document.getElementById("start-game-btn");if(H){const[e]=a.processButtonTexts([t.UI.BUTTONS.START_ADVENTURE]);H.innerHTML=e.html,H.dataset.key=e.key}const V=document.querySelector("#character-creation h2");V&&(V.textContent=t.UI.SCREENS.CREATE_YOUR_BETTA)}updateSpellButtons(){const t=document.getElementById("bubble-blast-btn");if(t){const s=e.COMBAT.SPELLS.BUBBLE_BLAST,[n]=a.processButtonTexts([`Bubble Blast (${s.mpCost} MP)`]);t.innerHTML=n.html,t.dataset.key=n.key}const s=document.getElementById("happy-balloon-btn");if(s){const t=e.COMBAT.SPELLS.HAPPY_BALLOON_TIME,[n]=a.processButtonTexts([`Happy Balloon Time (${t.mpCost} MP)`]);s.innerHTML=n.html,s.dataset.key=n.key}const n=document.getElementById("gravel-grenade-btn");if(n){const t=e.COMBAT.SPELLS.GRAVEL_GRENADE,[s]=a.processButtonTexts([`Gravel Grenade (${t.mpCost} MP)`]);n.innerHTML=s.html,n.dataset.key=s.key}}setupEventListeners(){document.getElementById("audio-toggle")?.addEventListener("click",()=>this.toggleAudio()),document.addEventListener("keydown",e=>this.handleKeyboard(e)),document.addEventListener("keydown",e=>this.handleGlobalKeyboard(e))}setupEventDelegation(){document.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(!t)return;const a=t.dataset.action,s=t.dataset;switch(a){case"continue-dialogue":this.continueDialogue();break;case"end-dialogue":this.endDialogue();break;case"end-confirmation":this.endConfirmation();break;case"buy-item":this.buyItem(s.itemId);break;case"open-shop":this.openShopFromDialogue();break;case"rest-at-inn":this.restAtInnFromDialogue()}})}handleGlobalKeyboard(e){const t=e.key.toLowerCase(),a=document.getElementById("congratulations-popup");if(a&&a.classList.contains("show"))return"c"===t||"Enter"===e.key?(e.preventDefault(),e.stopPropagation(),void this.hideCongratulationsPopup()):void 0;if(this.isShowingConfirmation)this.handleConfirmationKeyboard(e);else if(this.dialogueActive)this.handleDialogueKeyboard(e);else if(this.shopOpen)this.handleShopKeyboard(e);else{if("character-creation"===this.currentScreen){const a=document.getElementById("betta-name"),s=document.activeElement===a;if("tab"===t)return e.preventDefault(),void(a&&(s?a.blur():a.focus()));if(!s&&("arrowleft"===t||"arrowright"===t))return e.preventDefault(),void this.cycleColorSelection("arrowright"===t?1:-1);s||document.querySelectorAll("button[data-key]").forEach(a=>{a.dataset.key!==t||a.disabled||(e.preventDefault(),a.click())}),s||document.querySelectorAll(".color-option").forEach(a=>{a.dataset.key===t&&(e.preventDefault(),a.click())})}if("title-screen"===this.currentScreen&&"s"===t){e.preventDefault();const t=document.getElementById("start-game-btn");return void(t&&t.click())}if("Enter"===e.key)switch(this.currentScreen){case"title-screen":{const e=document.getElementById("start-game-btn");e&&e.click();break}case"character-creation":{const e=document.getElementById("create-character");e&&!e.disabled&&e.click();break}}}}handleDialogueKeyboard(s){const n=s.key.toLowerCase(),i=document.querySelectorAll("#dialogue-options .dialogue-option:not(.disabled), #dialogue-options button"),o=document.getElementById("dialogue-text");if(o&&o.innerHTML.includes(t.SYSTEM.TEXT_CHECKS.SHOP_INVENTORY_TEXT)){if("m"===n||"enter"===n)return s.preventDefault(),void this.endDialogue();const e=document.querySelectorAll(".shop-item[data-key]");for(const t of e)if(t.dataset.key===n&&t.classList.contains("shop-item-buyable"))return s.preventDefault(),void t.click()}switch(n){case"c":{s.preventDefault();const e=[...i].find(e=>e.textContent.toLowerCase().includes("continue"));e&&e.click();break}case"enter":{s.preventDefault();const e=this.world.getCurrentDialogueState(),t=[...i].find(e=>e.textContent.toLowerCase().includes("continue"));if(t)t.click();else if(e&&e.isShop){const e=[...i].find(e=>e.textContent.toLowerCase().includes("browse"));if(e)e.click();else{const e=[...i].find(e=>e.textContent.toLowerCase().includes("goodbye"));e&&e.click()}}else if(e&&e.isInn){const e=[...document.querySelectorAll("#dialogue-options .dialogue-option, #dialogue-options button")].find(e=>e.textContent.toLowerCase().includes("rest")&&!e.classList.contains("disabled"));if(e)e.click();else{const e=[...i].find(e=>e.textContent.toLowerCase().includes("goodbye"));e&&e.click()}}else{const e=[...i].find(e=>e.textContent.toLowerCase().includes("goodbye"));e&&e.click()}break}case"r":{s.preventDefault();const n=[...document.querySelectorAll("#dialogue-options .dialogue-option, #dialogue-options button")].find(e=>e.textContent.toLowerCase().includes("rest")&&!e.classList.contains("disabled"));if(n)n.click();else{const s=this.world.getCurrentDialogueState();if(s&&s.isInn){const s=a.format(t.INN.REST_NOT_ENOUGH,{cost:e.SHOP.INN_REST.cost});this.displayMessage(s)}}break}case"b":{s.preventDefault();const e=[...i].find(e=>e.textContent.toLowerCase().includes("browse"));e&&e.click();break}case"g":{s.preventDefault();const e=[...i].find(e=>e.textContent.toLowerCase().includes("goodbye"));e&&e.click();break}case"d":{s.preventDefault();const e=document.querySelector(".shop-item-buyable .item-name");e&&e.innerHTML.includes("Dunkleosteus")&&e.closest(".shop-item").click();break}case"k":{s.preventDefault();const e=[...document.querySelectorAll(".shop-item-buyable .item-name")].find(e=>e.innerHTML.includes("Kelp"));e&&e.closest(".shop-item").click();break}}}handleConfirmationKeyboard(e){const t=e.key.toLowerCase(),a=document.querySelectorAll("#dialogue-options .dialogue-option");if("enter"===t)return e.preventDefault(),void(a.length>0&&a[0].click());for(const s of a){const a=s.innerHTML.match(/<u>([a-zA-Z])<\/u>/);if(a&&a[1].toLowerCase()===t)return e.preventDefault(),void s.click()}}handleShopKeyboard(e){switch(e.key.toLowerCase()){case"l":case"enter":e.preventDefault(),this.toggleShop();break;case"d":e.preventDefault(),this.buyItem("submarine");break;case"k":e.preventDefault(),this.buyItem("kelp_snack");break;case"b":e.preventDefault(),this.buyItem("bubble_water")}}handleKeyboard(s){if(this.dialogueActive||"start"===this.currentScreen||this.isShowingConfirmation)return;const n=s.key.toLowerCase();if("combat"===this.currentScreen&&this.combat.isCombatActive())switch(n){case"a":s.preventDefault(),this.playerAttack();break;case"b":s.preventDefault(),this.isButtonVisible("bubble-blast-btn")&&this.player.canCastSpell("bubble")?this.playerCastSpell("bubble"):this.player.canCastSpell("bubble")||(this.combat.displayCombatMessage(a.format(t.COMBAT.NOT_ENOUGH_MP,{spellName:e.COMBAT.SPELLS.BUBBLE_BLAST.name})),this.updateCombatLog());break;case"h":s.preventDefault(),this.player.hasSpell("party")&&(this.player.canCastSpell("party")?this.playerCastSpell("party"):(this.combat.displayCombatMessage(a.format(t.COMBAT.NOT_ENOUGH_MP,{spellName:e.COMBAT.SPELLS.HAPPY_BALLOON_TIME.name})),this.updateCombatLog()));break;case"g":s.preventDefault(),this.player.hasSpell("gravel")&&(this.player.canCastSpell("gravel")?this.playerCastSpell("gravel"):(this.combat.displayCombatMessage(a.format(t.COMBAT.NOT_ENOUGH_MP,{spellName:e.COMBAT.SPELLS.GRAVEL_GRENADE.name})),this.updateCombatLog()));break;case"s":s.preventDefault(),this.playerRunAway()}else{if("world-map"===this.currentScreen)switch(s.key){case"ArrowUp":s.preventDefault(),this.movePlayer("north");break;case"ArrowDown":s.preventDefault(),this.movePlayer("south");break;case"ArrowLeft":s.preventDefault(),this.movePlayer("west");break;case"ArrowRight":s.preventDefault(),this.movePlayer("east");break;case"Home":s.preventDefault(),this.returnToVillage()}if("village"===this.currentScreen){if(this.villageButtons){const e=["elder","merchant","guard","bubble","innkeeper","exit"];this.villageButtons.forEach((t,a)=>{t.key===n&&(s.preventDefault(),5===a?this.leaveVillage():this.talkToNPC(e[a]))})}if("ArrowDown"===s.key)return s.preventDefault(),void(this.blockVillageExit||this.leaveVillage())}if("$"===n&&(s.preventDefault(),this.player.gainBettaBites(100),this.displayMessage(t.SYSTEM.CHEATS.BETTA_BITES_ADDED),this.updateAllDisplays()),"%"===n){s.preventDefault();const e=this.player.getExpToNext()-this.player.getExp();this.player.gainExp(e)&&(this.player.levelUp(),this.audio.playSound("levelup"),this.displayMessage(t.SYSTEM.CHEATS.LEVEL_UP_APPLIED),this.updateAllDisplays())}"+"===n&&(s.preventDefault(),this.player.fullHeal(),this.displayMessage(t.SYSTEM.CHEATS.HP_MP_RESTORED),this.updateAllDisplays())}}showScreen(e){this.currentScreen=e,this.hideAllScreens(),document.querySelectorAll(".background-container").forEach(e=>{e.classList.remove("active")});const t={"title-screen":"title-screen","character-creation":"character-creation",village:"village","world-map":"world-map",dialogue:"dialogue",combat:"combat"}[e]||"gameArea";switch(this.showElement(t),e){case"title-screen":case"character-creation":break;case"village":document.getElementById("village-container")?.classList.add("active"),this.showVillageScreen();break;case"world-map":document.getElementById("world-container")?.classList.add("active"),this.showWorldMapScreen();break;case"dialogue":this.determineDialogueBackground();break;case"combat":this.determineCombatBackground(),this.showCombatScreen()}this.updateAllDisplays()}showStartScreen(){this.showScreen("title-screen"),this.hideStatsPanel()}showGameScreen(){this.world.isInVillage()?this.showScreen("village"):this.showScreen("world-map")}showVillageScreen(){const e=document.getElementById("dynamic-world-style");e&&e.remove(),this.showStatsPanel()}showWorldMapScreen(){this.createLayeredWorldBackground(),this.showRicePaddies(),this.showPlayerOnMap(),this.showStatsPanel()}showCombatScreen(){const e=document.getElementById("enemy-fish-combat");e&&(e.style.visibility="hidden",e.src=""),this.showStatsPanel(),this.updateCombatDisplay(),this.enableCombatButtons()}hideAllScreens(){["title-screen","character-creation","village","world-map","dialogue","combat"].forEach(e=>this.hideElement(e))}showElement(e){const t=document.getElementById(e);t&&(t.classList.add("active"),t.style.display="block")}hideElement(e){const t=document.getElementById(e);t&&(t.classList.remove("active"),t.style.display="none")}startNewGame(){this.showCharacterCreation()}showCharacterCreation(){this.showScreen("character-creation"),this.hideStatsPanel(),this.setupCharacterCreationForm()}setupCharacterCreationForm(){let e="red";const s=this.generateRandomName(),n=document.getElementById("betta-name"),i=document.getElementById("preview-name"),o=document.getElementById("create-character"),r=document.getElementById("random-name-btn"),l=document.querySelectorAll(".color-option"),c=document.getElementById("preview-color"),h=document.getElementById("betta-preview");if(n&&n.parentNode){const e=n.cloneNode(!0);n.parentNode.replaceChild(e,n)}if(o&&o.parentNode){const e=o.cloneNode(!0);o.parentNode.replaceChild(e,o)}if(r&&r.parentNode){const e=r.cloneNode(!0);r.parentNode.replaceChild(e,r)}const d=document.getElementById("betta-name"),u=document.getElementById("create-character"),m=document.getElementById("random-name-btn");d&&(d.value=s),i&&(i.textContent=s),c&&(c.textContent=t.UI.COLORS.RED),l.forEach(e=>{"red"===e.dataset.color?(e.classList.add("selected"),h&&(h.style.filter="hue-rotate(0deg) saturate(1.2)")):e.classList.remove("selected")}),this.updateCreateButtonState(s,e),d&&(d.addEventListener("input",()=>{const a=d.value.trim();i&&(i.textContent=a||t.CHARACTER_CREATION.PREVIEW.UNKNOWN_NAME),this.updateCreateButtonState(a,e)}),d.addEventListener("keydown",e=>{if("Enter"===e.key){const e=document.getElementById("create-character");e&&!e.disabled&&e.click()}})),m&&m.addEventListener("click",()=>{const t=this.generateRandomName();d&&(d.value=t),i&&(i.textContent=t),this.updateCreateButtonState(t,e)}),l.forEach(t=>{t.addEventListener("click",()=>{if(l.forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),e=t.dataset.color,c&&(c.textContent=e.charAt(0).toUpperCase()+e.slice(1)),h){const t={red:"hue-rotate(0deg) saturate(1.2)",blue:"hue-rotate(180deg) saturate(1.3)",purple:"hue-rotate(270deg) saturate(1.8)",green:"hue-rotate(140deg) saturate(1.2) brightness(0.85)",orange:"hue-rotate(30deg) saturate(1.8) brightness(1.1)"};h.style.filter=t[e]||"none"}const a=d?d.value.trim():"";this.updateCreateButtonState(a,e)})}),u&&u.addEventListener("click",()=>{const s=d?d.value.trim():"";s&&e&&(this.player.setPlayerIdentity(s,e),this.showScreen("village"),this.displayMessage(a.format(t.CHARACTER_CREATION.WELCOME_MESSAGE,{playerName:s})))})}updateCreateButtonState(e,s){const n=document.getElementById("create-character");if(n)if(e&&s){n.disabled=!1;const[e]=a.processButtonTexts([t.UI.BUTTONS.START_GAME]);n.innerHTML=e.html,n.dataset.key=e.key}else n.disabled=!0,n.textContent=e?t.UI.LABELS.CHOOSE_COLOR:s?t.UI.LABELS.ENTER_NAME:t.UI.LABELS.ENTER_NAME_AND_CHOOSE_COLOR}cycleColorSelection(e){const t=document.querySelectorAll(".color-option"),a=Array.from(t).map(e=>e.dataset.color);let s=-1;t.forEach((e,t)=>{e.classList.contains("selected")&&(s=t)}),-1===s&&(s=0);let n=s+e;n<0&&(n=a.length-1),n>=a.length&&(n=0),t[n]&&t[n].click()}selectColorByName(e){document.querySelectorAll(".color-option").forEach(t=>{t.dataset.color===e&&t.click()})}movePlayer(e){if(this.combat.isCombatActive()||this.dialogueActive)return;if("east"===e?this.playerFacing="right":"west"===e&&(this.playerFacing="left"),!this.world.isInVillage()){const a={north:t.EXPLORATION.MOVEMENT.DIRECTIONS.NORTH,south:t.EXPLORATION.MOVEMENT.DIRECTIONS.SOUTH,east:t.EXPLORATION.MOVEMENT.DIRECTIONS.EAST,west:t.EXPLORATION.MOVEMENT.DIRECTIONS.WEST};this.displayMessage(a[e])}const a=this.world.movePlayer(e);if(!a.success)return void this.displayMessage(a.reason);const s="village"===this.currentScreen,n=this.world.isInVillage();s&&!n?this.showScreen("world-map"):!s&&n&&(this.showScreen("village"),this.blockVillageExit=!0,setTimeout(()=>{this.blockVillageExit=!1},100)),a.message&&this.displayMessage(a.message),a.showCongratulations&&this.showCongratulationsPopup(),a.encounter&&this.handleEncounter(a.encounter),this.updatePlayerMapPosition(),this.updateAllDisplays()}handleEncounter(e){switch(e.type){case"combat":e.message&&this.displayMessage(e.message),this.startCombat(e.enemy);break;case"treasure":case"peaceful":this.displayMessage(e.message);break;case"mystery":this.displayMessage(e.message),e.effectMessage&&setTimeout(()=>this.displayMessage(e.effectMessage),1e3)}}startCombat(e){this.showScreen("combat");const t=document.getElementById("enemy-hp-bar");t&&(t.classList.remove("rainbow-friendship"),t.style.width="");const a=document.querySelector(".enemy-combat > div:last-child");a&&(a.innerHTML.includes("HP:")||(a.innerHTML='HP: <span id="enemy-hp-text"></span>')),this.updateCombatDisplay(),this.enableCombatButtons(),document.getElementById("combat")?.classList.remove("combat-over")}endCombat(){const e=this.combat.shouldShowPeaceMessage();this.combat.shouldShowCongratulations()?(this.showCongratulationsPopup(()=>{e&&(this.showPeaceMessage(),this.combat.clearPeaceMessageFlag())}),this.combat.clearCongratulationsFlag()):e&&(this.showPeaceMessage(),this.combat.clearPeaceMessageFlag()),document.querySelectorAll(".balloon-container").forEach(e=>{const t=parseInt(e.dataset.createdAt||0);Date.now()-t>3e3&&e.remove()}),this.disableCombatButtons(),this.showGameScreen(),this.combat.playerHasPartyHat=!1,this.updatePlayerStats()}updateCombatDisplay(){const a=this.combat.getCurrentEnemy();if(!a)return;if(this.setTextContent("player-name-combat",this.player.getName()),this.setTextContent("enemy-name",a.name),this.setTextContent("enemy-level",`Level ${a.level}`),this.updateHPBar("player-hp-bar",this.player.getHP(),this.player.getMaxHP()),this.combat.isBefriendingCurrentEnemy()){const e=document.querySelector(".enemy-combat > div:last-child");e&&e.textContent.includes("HP:")&&(e.textContent=t.COMBAT.MADE_FRIEND)}else this.updateHPBar("enemy-hp-bar",a.hp,a.maxHp),this.setTextContent("enemy-hp-text",`${a.hp}/${a.maxHp}`);if(this.updatePlayerStats(),this.updateCombatLog(),!a.hasPartyHat){const e=document.getElementById("enemy-fish-combat");e&&(e.style.visibility="hidden",e.src=a.sprite,e.style.filter=a.randomHue?`hue-rotate(${a.randomHue}deg)`:"none",e.style.visibility="visible")}const s=document.getElementById("swim-away-message");s&&(a.level>=e.COMBAT.RUN_AWAY.difficultEnemyLevel?s.textContent="‚ö° Escape is very difficult! ‚ö°":s.textContent="");const n=document.getElementById("player-fish-combat");n&&(n.src=this.player.getSprite(),n.style.filter=this.player.getColorFilter());const i=document.getElementById("bubble-blast-btn"),o=document.getElementById("happy-balloon-btn"),r=document.getElementById("gravel-grenade-btn");i&&(i.disabled=!this.player.canCastSpell("bubble")),o&&(this.player.hasSpell("party")?(o.style.display="inline-block",o.disabled=!this.player.canCastSpell("party")):o.style.display="none"),r&&(this.player.hasSpell("gravel")?(r.style.display="inline-block",r.disabled=!this.player.canCastSpell("gravel")):r.style.display="none")}updateCombatLog(){const e=document.getElementById("combat-log");if(!e)return;const t=this.combat.getCombatLog();e.innerHTML=t.map(e=>`<div class="log-entry">${e}</div>`).join(""),e.scrollTop=0}enableCombatButtons(){const e=document.getElementById("bubble-blast-btn"),t=document.getElementById("happy-balloon-btn"),a=document.getElementById("gravel-grenade-btn");e&&(e.removeAttribute("disabled"),e.style.display="block"),t&&(this.player.hasSpell("party")?(t.removeAttribute("disabled"),t.style.display="block"):t.style.display="none"),a&&(this.player.hasSpell("gravel")?(a.removeAttribute("disabled"),a.style.display="block"):a.style.display="none"),document.getElementById("swim-away-btn")?.removeAttribute("disabled")}disableCombatButtons(){["bubble-blast-btn","happy-balloon-btn","gravel-grenade-btn","swim-away-btn"].forEach(e=>{document.getElementById(e)?.setAttribute("disabled","true")})}playerAttack(){const e=this.combat.attack();if(e&&e.playerDefeated)this.checkAndHandlePlayerDefeat();else{if(e&&e.enemyDefeated)return this.updateCombatDisplay(),this.updateCombatLog(),void setTimeout(()=>{this.combat.processCombatVictory(e=>{this.handleVictory(e)})},250);this.combat.isCombatActive()?this.updateCombatDisplay():(this.updateCombatLog(),setTimeout(()=>this.endCombat(),1500))}}checkAndHandlePlayerDefeat(){return!this.player.isAlive&&!this.defeatInProgress&&(this.defeatInProgress=!0,this.updateCombatDisplay(),this.updateCombatLog(),setTimeout(()=>{this.handlePlayerDefeat()},250),!0)}playerCastSpell(s){if(!this.player.canCastSpell(s)){let n;return n="bubble"===s?e.COMBAT.SPELLS.BUBBLE_BLAST.name:"party"===s?e.COMBAT.SPELLS.HAPPY_BALLOON_TIME.name:e.COMBAT.SPELLS.GRAVEL_GRENADE.name,this.combat.displayCombatMessage(a.format(t.COMBAT.NOT_ENOUGH_MP,{spellName:n})),void this.updateCombatLog()}const n=this.combat.useSkill(s);if(n&&n.playerDefeated)this.checkAndHandlePlayerDefeat();else if(n&&n.enemyDefeated){if(this.updateCombatDisplay(),this.updateCombatLog(),n.enemy&&n.enemy.befriended&&this.combat.playerHasPartyHat){const e=document.getElementById("player-fish-combat"),t=document.getElementById("stats-player-sprite"),a=this.player.getSprite(),s=this.combat.getPartyHatSprite(a);s&&(e&&(e.src=s),t&&(t.src=s))}setTimeout(()=>{this.combat.processCombatVictory(e=>{this.handleVictory(e)})},2e3)}else this.combat.isCombatActive()?this.updateCombatDisplay():(this.updateCombatLog(),setTimeout(()=>this.endCombat(),1500))}playerRunAway(){const e=this.combat.runAway();this.updateCombatDisplay(),this.updateCombatLog(),e.playerDefeated?this.checkAndHandlePlayerDefeat():!e.escaped&&this.combat.isCombatActive()||(this.displayMessage(t.COMBAT.ESCAPE_SUCCESS),setTimeout(()=>this.endCombat(),1e3))}handleVictory(e){if(document.getElementById("combat")?.classList.add("combat-over"),e.defeatedEnemy){this.displayMessage(a.format(t.COMBAT.ENEMY_APPEARS,{enemyName:e.defeatedEnemy.name,level:e.defeatedEnemy.level}));const s=e.defeatedEnemy.befriended?t.COMBAT.ENEMY_BEFRIENDED:t.COMBAT.ENEMY_DEFEATED;this.displayMessage(a.format(s,{enemyName:e.defeatedEnemy.name}))}const s=e.defeatedEnemy&&e.defeatedEnemy.befriended;e.levelUp?setTimeout(()=>this.endCombat(),1e3):s?setTimeout(()=>this.endCombat(),2e3):this.endCombat()}handlePlayerDefeat(){document.getElementById("combat")?.classList.add("combat-over");const e=this.combat.loseCombat();e.defeatedByEnemy&&this.displayMessage(`The last thing you remember is a wild ${e.defeatedByEnemy.name}!`),this.updateCombatDisplay(),this.updateCombatLog(),setTimeout(()=>{this.world.teleportToVillage(),this.showScreen("village");const s=document.getElementById("player-fish-combat");s&&(s.style.transform="none");const n=document.getElementById("stats-player-sprite");n&&(n.style.transform="none"),e.bettaBitesLost>0?(this.displayMessage(t.COMBAT.DEFEAT_RECOVERY_RESCUED),this.displayMessage(a.format(t.COMBAT.DEFEAT_RECOVERY_LOSS,{amount:e.bettaBitesLost}))):this.displayMessage(t.COMBAT.DEFEAT_RECOVERY),this.defeatInProgress=!1,this.updateAllDisplays()},3500)}enterVillage(){const e=this.world.enterVillage();this.displayMessage(e.message),e.success&&this.showScreen("village"),this.updateAllDisplays()}returnToVillage(){const e=this.world.teleportToVillage();this.displayMessage(e.message),this.showScreen("village"),this.updateAllDisplays()}leaveVillage(){const e=this.world.leaveVillage();this.displayMessage(e.message),e.success&&(this.showScreen("world-map"),this.updatePlayerMapPosition()),this.updateAllDisplays()}exitVillage(){this.leaveVillage()}toggleShop(){this.shopOpen=!this.shopOpen,this.shopOpen?this.showShop():this.hideShop()}toggleAudio(){if(!this.audio)return;const e=this.audio.toggleAudio(),t=document.getElementById("audio-toggle");t&&(t.textContent=e?"üîä":"üîá",t.classList.toggle("muted",!e),t.title=e?"Toggle Audio (On)":"Toggle Audio (Off)")}showShop(){const e=document.getElementById("shopArea");if(!e)return;e.style.display="block";const t=this.world.getShopItems().map(e=>{const t=this.player.canAfford(e.cost);return`\n                <div class="shop-item ${t?"shop-item-buyable":"shop-item-unavailable"}">\n                    <h4 class="item-name">${e.name}</h4>\n                    <p>${e.description}</p>\n                    <p>Cost: ${e.cost} Betta Bites</p>\n                    ${t?`<button data-action="buy-item" data-item-id="${e.id}">Buy</button>`:""}\n                </div>\n            `}).join(""),a=document.getElementById("shopItems");a&&(a.innerHTML=t)}hideShop(){const e=document.getElementById("shopArea");e&&(e.style.display="none")}talkToNPC(e){const t=this.world.talkToNPC(e);t.success?this.showDialogueScreen(t):this.displayMessage(t.message)}showDialogueScreen(e){this.showScreen("dialogue"),this.dialogueActive=!0,this.displayDialogue(e)}displayDialogue(e){this.showEnhancedDialogue(e)}showEnhancedDialogue(s){const n=document.getElementById("npc-name"),i=document.getElementById("dialogue-text"),o=document.getElementById("dialogue-options");n&&(n.textContent=s.npc.name),i&&(i.textContent=s.dialogue);let r="";if(s.hasMoreDialogue){const e=a.processButtonTexts([t.UI.BUTTONS.CONTINUE]);r+=`<div class="dialogue-option" data-action="continue-dialogue">${e[0].html}</div>`}else{const n=[],i=[];s.isShop&&(n.push(t.UI.BUTTONS.BROWSE_ITEMS),i.push("open-shop")),s.isInn&&(this.player.canAfford(e.SHOP.INN_REST.cost)?(n.push(a.format(t.UI.BUTTONS.REST_WITH_COST,{cost:e.SHOP.INN_REST.cost})),i.push("rest-at-inn")):r+=`<div class="dialogue-option disabled">${a.format(t.UI.BUTTONS.REST,{cost:e.SHOP.INN_REST.cost})}${t.UI.DIALOGUE_OPTIONS.REST_SUFFIX}</div>`),n.push(t.UI.BUTTONS.GOODBYE),i.push("end-dialogue"),a.processButtonTexts(n).forEach((e,t)=>{r+=`<div class="dialogue-option" data-action="${i[t]}">${e.html}</div>`})}o&&(o.innerHTML=r)}continueDialogue(){const e=this.world.nextDialogue();e.success?this.showEnhancedDialogue(e):this.endDialogue()}openShopFromDialogue(){const e=document.getElementById("dialogue-text"),s=document.getElementById("dialogue-options");if(e){const s=this.world.getShopItems(),n=s.map(e=>e.name),i=a.processButtonTexts(n);let o="";s.forEach((e,a)=>{const s=this.player.canAfford(e.cost),n=s?`data-action="buy-item" data-item-id="${e.id}"`:"",r=s?"shop-item-buyable":"shop-item-unavailable",l=i[a];o+=`\n                    <div class="shop-item ${r}" ${n} data-key="${l.key}">\n                        <div class="item-name">${l.html}</div>\n                        <div class="item-description">${e.description}</div>\n                        <div class="item-price">${e.cost}${t.SHOP.INLINE_SHOP.COST_SUFFIX}</div>\n                    </div>\n                `}),e.innerHTML=`\n                <div class="shop-header">${t.SHOP.INLINE_SHOP.HEADER}</div>\n                <div class="shop-items">\n                    ${o}\n                </div>\n                <div class="shop-footer">${a.format(t.SHOP.INLINE_SHOP.FOOTER,{bettaBites:this.player.getBettaBites()})}</div>\n            `}if(s){const[e]=a.processButtonTexts([t.UI.BUTTONS.MAYBE_LATER]);s.innerHTML=`<div class="dialogue-option" data-action="end-dialogue">${e.html}</div>`}}restAtInnFromDialogue(){const s=this.world.restAtInn();if(s.success){this.updateAllDisplays();const s=document.getElementById("dialogue-text"),n=document.getElementById("dialogue-options");if(s&&n){this.isShowingConfirmation=!0,s.textContent=a.format(t.INN.REST_SUCCESS,{cost:e.SHOP.INN_REST.cost});const[i]=a.processButtonTexts([t.UI.BUTTONS.CLOSE]);n.innerHTML=`<div class="dialogue-option" data-action="end-confirmation">${i.html}</div>`}}else this.displayMessage(s.message),this.endDialogue()}endConfirmation(){this.isShowingConfirmation=!1,this.endDialogue()}endDialogue(){this.world.endDialogue(),this.dialogueActive=!1,this.showGameScreen(),this.updateAllDisplays()}showCongratulationsPopup(e){const t=document.getElementById("congratulations-popup");t&&(t.classList.add("show"),this.congratsCloseCallback=e)}hideCongratulationsPopup(){const e=document.getElementById("congratulations-popup");if(e&&(e.classList.remove("show"),this.congratsCloseCallback)){const e=this.congratsCloseCallback;this.congratsCloseCallback=null,setTimeout(()=>e(),500)}}showPeaceMessage(){const e=document.createElement("div");e.className="peace-popup",e.innerHTML=`\n            <h2 style="margin-bottom: 1.5rem;">${t.SYSTEM.CONGRATULATIONS.ALL_FRIENDS_TITLE}</h2>\n            <p style="margin-bottom: 1rem;">${t.SYSTEM.CONGRATULATIONS.ALL_FRIENDS_MESSAGE}</p>\n            <p style="margin-bottom: 2rem;">${t.SYSTEM.CONGRATULATIONS.ALL_FRIENDS_SUBTITLE}</p>\n            <button id="peace-continue-btn"><u>C</u>ontinue</button>\n        `,e.style.cssText="\n            position: fixed;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 2rem;\n            border-radius: 1rem;\n            text-align: center;\n            z-index: 10000;\n            box-shadow: 0 10px 40px rgba(0,0,0,0.5);\n            animation: fadeInScale 0.5s ease-out;\n        ",document.body.appendChild(e);const a=document.getElementById("peace-continue-btn");a.addEventListener("click",()=>e.remove());const s=t=>{"Enter"!==t.key&&"c"!==t.key&&"C"!==t.key||(e.remove(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s),a.focus(),this.audio.playSound("fanfare")}updateAllDisplays(){this.updatePlayerStats(),this.updateVillageButtons(),"world-map"===this.currentScreen&&this.showPlayerOnMap()}updatePlayerStats(){this.setTextContent("player-name-display",this.player.getName()),this.setTextContent("level",this.player.getLevel()),this.setTextContent("exp",this.player.getExp()),this.setTextContent("exp-next",this.player.getExpToNext()),this.setTextContent("betta-bites",this.player.getBettaBites()),this.setTextContent("hp",this.player.getHP()),this.setTextContent("max-hp",this.player.getMaxHP()),this.setTextContent("mp",this.player.getMP()),this.setTextContent("max-mp",this.player.getMaxMP()),this.setTextContent("player-name-combat",this.player.getName()),this.setTextContent("player-hp-text",`${this.player.getHP()}/${this.player.getMaxHP()}`);const e=document.getElementById("stats-player-sprite"),t=document.getElementById("player-fish-combat");this.combat.playerHasPartyHat||(e&&(e.src=this.player.getSprite(),e.style.filter=this.player.getColorFilter()),t&&(t.src=this.player.getSprite(),t.style.filter=this.player.getColorFilter())),this.updateHPBar("player-hp-bar",this.player.getHP(),this.player.getMaxHP())}updateVillageButtons(){const e=this.world.isInVillage(),t=document.getElementById("enterVillageBtn"),a=document.getElementById("leaveVillageBtn"),s=document.getElementById("shopBtn");t&&(t.style.display=e?"none":"block"),a&&(a.style.display=e?"block":"none"),s&&(s.style.display=e?"block":"none")}updateHPBar(e,t,a){const s=document.getElementById(e);if(!s)return;const n=t/a*100;s.style.width=`${n}%`,s.style.backgroundColor=n>60?"#4CAF50":n>30?"#FF9800":"#F44336"}setTextContent(e,t){const a=document.getElementById(e);a&&(a.textContent=t)}displayMessage(e){[document.getElementById("encounter-log"),document.getElementById("village-encounter-log")].forEach(t=>{if(t){const a=document.createElement("div");for(a.className="log-entry",a.textContent=e,t.insertBefore(a,t.firstChild);t.children.length>8;)t.removeChild(t.lastChild);t.scrollTop=0}})}updatePlayerSpritesWithPartyHat(){const e=this.player.getSprite(),t=this.combat.getPartyHatSprite(e);if(!t)return;const a=document.getElementById("player-fish-combat"),s=document.getElementById("stats-player-sprite");a&&(a.src=t),s&&(s.src=t)}applyRainbowHPEffect(){const e=document.getElementById("enemy-hp-bar");e&&(e.classList.add("rainbow-friendship"),e.style.width="100%")}generateRicePaddyPositions(){const e=[];let t=12345;const a=()=>(t=(9301*t+49297)%233280,t/233280);for(let t=0;t<25;t++)e.push({x:80*a()+10,y:80*a()+10,scale:.4*a()+.8});return e}createLayeredWorldBackground(){document.querySelectorAll(".rice-paddy-tuft, .betta-village, .map-player, .danger-zone-border, .safe-water-zone").forEach(e=>e.remove());const e=document.getElementById("dynamic-world-style");if(e&&e.remove(),this.backgroundPreRenderComplete)return;const t=document.getElementById("world-container");this.cachedWorldBackground?t.style.backgroundImage=`url(${this.cachedWorldBackground})`:this.generateTiledBackground().then(e=>{t.style.backgroundImage=`url(${e})`}).catch(e=>{console.error("Failed to generate tile background:",e),t.style.backgroundImage="url(graphics/map/water-tile-dark.png)",t.style.backgroundRepeat="repeat",t.style.backgroundSize="64px 64px"})}async generateTiledBackground(){if(this.cachedWorldBackground)return this.cachedWorldBackground;const t=e.WORLD.MAP_SIZE,a=64*t,s=document.createElement("canvas");s.width=a,s.height=a;const n=s.getContext("2d");this.cachedWaterTiles||(this.cachedWaterTiles=await this.loadWaterTileImages());const i=this.cachedWaterTiles;for(let e=0;e<t;e++)for(let a=0;a<t;a++){const t=this.world.getDistanceFromVillage(a,e),s=this.getTileImageForDistance(t,i);n.drawImage(s,64*a,64*e,64,64)}try{return this.cachedWorldBackground=s.toDataURL("image/png"),this.cachedWorldBackground}catch(e){return console.warn("Canvas toDataURL failed (likely CORS), generating without caching:",e),s.toDataURL("image/png")}}async loadWaterTileImages(){const e=[this.loadImage("graphics/map/water-tile2.png"),this.loadImage("graphics/map/water-tile-darkish.png"),this.loadImage("graphics/map/water-tile-dark.png")],[t,a,s]=await Promise.all(e);return{light:t,medium:a,dark:s}}loadImage(e){return new Promise((t,a)=>{const s=new Image;s.onload=()=>t(s),s.onerror=a,s.src=e})}getTileImageForDistance(t,a){const s=e.WORLD.DANGER_ZONES;return t<=s.SAFE_RADIUS?a.light:t<=s.DANGEROUS_RADIUS?a.medium:a.dark}showRicePaddies(){const t=document.getElementById("world-map");this.ricePaddyPositions.forEach((e,a)=>{const s=document.createElement("img");s.src="graphics/map/rice_paddy_tuft.png",s.className="rice-paddy-tuft",s.style.position="absolute",s.style.left=`${e.x}%`,s.style.top=`${e.y}%`,s.style.transform=`scale(${e.scale})`,s.style.pointerEvents="none",s.style.zIndex="1",s.style.imageRendering="pixelated",t.appendChild(s)});const a=document.createElement("img");a.src="graphics/map/bettahome.png",a.className="betta-village",a.style.position="absolute";const s=64*e.WORLD.VILLAGE_CENTER.x+32,n=64*e.WORLD.VILLAGE_CENTER.y+32,i=64*e.WORLD.MAP_SIZE;a.style.left=s/i*100+"%",a.style.top=n/i*100+"%",a.style.transform="translate(-50%, -50%)",a.style.pointerEvents="none",a.style.zIndex="2",a.style.imageRendering="pixelated",t.appendChild(a)}showPlayerOnMap(){const t=document.getElementById("world-map"),a=document.querySelector(".map-player");a&&a.remove();const s=document.createElement("img");s.src=this.player.getSprite(),s.className=this.player.hasSubmarine()?"map-player submarine":"map-player",s.style.position="absolute";const n=this.world.getCurrentLocation(),i=64*n.x+32,o=64*n.y+32,r=64*e.WORLD.MAP_SIZE;s.style.left=i/r*100+"%",s.style.top=o/r*100+"%";const l="left"===this.playerFacing?"scaleX(-1)":"";s.style.transform=`translate(-50%, -50%) ${l}`,s.style.zIndex="10",s.style.imageRendering="pixelated",s.style.width="48px",s.style.height="48px",this.player.hasSubmarine()?s.style.filter="drop-shadow(2px 2px 4px rgba(0,0,0,0.5))":s.style.filter=this.player.getColorFilter()+" drop-shadow(2px 2px 4px rgba(0,0,0,0.5))",t.appendChild(s)}updatePlayerMapPosition(){const t=this.world.getCurrentLocation();this.playerMapPosition.x=t.x/e.WORLD.MAP_SIZE*100,this.playerMapPosition.y=t.y/e.WORLD.MAP_SIZE*100,"world-map"===this.currentScreen&&this.showPlayerOnMap()}showStatsPanel(){const e=document.getElementById("player-stats");e&&e.classList.add("show")}hideStatsPanel(){const e=document.getElementById("player-stats");e&&e.classList.remove("show")}determineDialogueBackground(){this.world.isInVillage()?document.getElementById("village-container")?.classList.add("active"):document.getElementById("world-container")?.classList.add("active")}determineCombatBackground(){this.world.isInVillage()?document.getElementById("village-container")?.classList.add("active"):document.getElementById("world-container")?.classList.add("active")}async preRenderWorldBackground(){if(!this.backgroundPreRenderComplete)try{const e=await this.generateTiledBackground(),t=document.getElementById("world-container");t&&e&&(t.style.backgroundImage=`url(${e})`,this.backgroundPreRenderComplete=!0)}catch(e){}}initializeVillageBackground(){const e=document.getElementById("village-container");e&&(e.style.backgroundImage="url(graphics/map/water-tile-dark.png)",e.style.backgroundRepeat="repeat",e.style.backgroundSize="64px 64px",e.style.backgroundPosition="0 0",e.style.opacity="0",e.classList.add("active"),e.offsetHeight,e.classList.remove("active"),e.style.opacity="")}}class c{constructor(){this.player=new n,this.audio=new s,this.npcs=new i,this.combat=new o(this.player,this.audio),this.world=new r(this.player,this.audio,this.combat,this.npcs),this.combat.setWorldManager(this.world),this.ui=new l(this.player,this.audio,this.combat,this.world),this.ui.setCoreManager(this),this.combat.setUIManager(this.ui),this.attachEventListeners(),this.initializeAssets()}async initializeAssets(){try{this.preloadBackgroundImages(),await this.ui.preRenderWorldBackground()}catch(e){}}preloadBackgroundImages(){["graphics/map/water-tile-dark.png","graphics/map/water-tile2.png","graphics/map/water-tile-darkish.png"].forEach(e=>{(new Image).src=e})}attachEventListeners(){document.getElementById("start-game-btn").addEventListener("click",()=>this.startCharacterCreation()),document.getElementById("elder-dwelling").addEventListener("click",()=>this.talkToNPC("elder")),document.getElementById("fish-mart").addEventListener("click",()=>this.talkToNPC("merchant")),document.getElementById("village-guard").addEventListener("click",()=>this.talkToNPC("guard")),document.getElementById("bubbles-home").addEventListener("click",()=>this.talkToNPC("bubble")),document.getElementById("swishy-solace-inn").addEventListener("click",()=>this.talkToNPC("innkeeper")),document.getElementById("exit-to-paddies").addEventListener("click",()=>this.exitVillage()),document.getElementById("swim-north-btn").addEventListener("click",()=>this.swimDirection("north")),document.getElementById("swim-west-btn").addEventListener("click",()=>this.swimDirection("west")),document.getElementById("swim-east-btn").addEventListener("click",()=>this.swimDirection("east")),document.getElementById("swim-south-btn").addEventListener("click",()=>this.swimDirection("south")),document.getElementById("return-village-btn").addEventListener("click",()=>this.returnToVillage()),document.getElementById("attack-btn").addEventListener("click",()=>this.attack()),document.getElementById("bubble-blast-btn").addEventListener("click",()=>this.useSkill("bubble")),document.getElementById("gravel-grenade-btn").addEventListener("click",()=>this.useSkill("gravel")),document.getElementById("happy-balloon-btn").addEventListener("click",()=>this.useSkill("party")),document.getElementById("swim-away-btn").addEventListener("click",()=>this.runAway())}startCharacterCreation(){this.ui.startNewGame()}talkToNPC(e){this.ui.talkToNPC(e)}exitVillage(){this.ui.leaveVillage()}swimDirection(e){this.ui.movePlayer(e)}returnToVillage(){this.ui.returnToVillage()}attack(){this.ui.playerAttack()}useSkill(e){this.ui.playerCastSpell(e)}runAway(){this.ui.playerRunAway()}newGame(){this.player.reset(),this.world.reset(),this.combat.reset(),this.ui.showStartScreen()}getVersion(){return{version:e.GAME.VERSION,website:e.GAME.WEBSITE}}}document.addEventListener("DOMContentLoaded",()=>{new c})})();